<html lang="zh-Hans-CN"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" href="/assets/a0736d0e7e8d470e.png"/><script src="/assets/EWFGSKOU.js" async=""></script><title>JavaScript 作用域和闭包</title><meta name="title" content="JavaScript 作用域和闭包"/><meta name="og:site_name" content="WeAreOutMan"/><meta name="og:title" content="JavaScript 作用域和闭包"/><meta name="og:type" content="article"/><meta name="og:url" content="https://www.wangshenwei.com/javascript-scopes-and-closures/"/><meta name="og:image" content="https://www.wangshenwei.com/assets/a0736d0e7e8d470e.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:url" content="https://www.wangshenwei.com/javascript-scopes-and-closures/"/><meta name="twitter:title" content="JavaScript 作用域和闭包"/><meta name="twitter:image" content="https://www.wangshenwei.com/assets/a0736d0e7e8d470e.png"/><link rel="icon" href="/assets/a0736d0e7e8d470e.png"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""/><link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&amp;family=Montserrat:wght@700;900&amp;display=swap" rel="stylesheet"/><link rel="stylesheet" href="/assets/main.caad21e9.css"/></head><body><header class="page-header"><a href="/">WeAreOutMan</a><color-mode-switch></color-mode-switch></header><main><article><h1>JavaScript 作用域和闭包</h1><p class="post-date">March 24, 2014</p><p>作用域的嵌套将形成<strong>作用域链</strong>，函数的嵌套将形成<strong>闭包</strong>。闭包与作用域链是 JavaScript 区别于其它语言的重要特性之一。</p>
<h3>作用域</h3>
<p>JavaScript 中有两种作用域：函数作用域和全局作用域。</p>
<p>在一个函数中声明的变量以及该函数的参数享有同一个作用域，即函数作用域。一个简单的函数作用域的例子：</p>
<pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#569CD6">function</span><span style="color:#DCDCAA"> foo</span><span style="color:#FFD700">(</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4"> </span><span style="color:#FFD700">{</span></span>
<span class="line"><span style="color:#569CD6">    var</span><span style="color:#9CDCFE"> bar</span><span style="color:#D4D4D4"> = </span><span style="color:#B5CEA8">1</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#D4D4D4">    </span><span style="color:#DA70D6">{</span></span>
<span class="line"><span style="color:#569CD6">        var</span><span style="color:#9CDCFE"> bar</span><span style="color:#D4D4D4"> = </span><span style="color:#B5CEA8">2</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#D4D4D4">    </span><span style="color:#DA70D6">}</span></span>
<span class="line"><span style="color:#C586C0">    return</span><span style="color:#9CDCFE"> bar</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// 2</span></span>
<span class="line"><span style="color:#FFD700">}</span></span></code></pre>
<p>不同于C等其它有<strong>块作用域</strong>的语言，这里将始终返回 <code>2</code> 。</p>
<p>全局作用域，对于浏览器来说可以理解为 <code>window</code> 对象（Node.js则是 <code>global</code>）：</p>
<pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#569CD6">var</span><span style="color:#9CDCFE"> bar</span><span style="color:#D4D4D4"> = </span><span style="color:#B5CEA8">1</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#569CD6">function</span><span style="color:#DCDCAA"> foo</span><span style="color:#FFD700">(</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4"> </span><span style="color:#FFD700">{</span><span style="color:#FFD700">}</span></span>
<span class="line"><span style="color:#DCDCAA">alert</span><span style="color:#FFD700">(</span><span style="color:#9CDCFE">window</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">bar</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// 1</span></span>
<span class="line"><span style="color:#DCDCAA">alert</span><span style="color:#FFD700">(</span><span style="color:#9CDCFE">window</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">foo</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// &quot;function foo() {}&quot;</span></span></code></pre>
<p>对于变量 <code>bar</code> 和函数 <code>foo</code> 都属于全局作用域，都是 <code>window</code> 的一个属性。</p>
<h3>作用域链</h3>
<p>在 JavaScript 中访问一个变量时，将从本地变量和参数开始，逐级向上遍历作用域直到全局作用域。</p>
<pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#569CD6">var</span><span style="color:#9CDCFE"> scope</span><span style="color:#D4D4D4"> = </span><span style="color:#B5CEA8">0</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">zero</span><span style="color:#D4D4D4"> = </span><span style="color:#CE9178">&quot;global-scope&quot;</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#FFD700">(</span><span style="color:#569CD6">function</span><span style="color:#DA70D6">(</span><span style="color:#DA70D6">)</span><span style="color:#DA70D6">{</span></span>
<span class="line"><span style="color:#569CD6">    var</span><span style="color:#9CDCFE"> scope</span><span style="color:#D4D4D4"> = </span><span style="color:#B5CEA8">1</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">one</span><span style="color:#D4D4D4"> = </span><span style="color:#CE9178">&quot;scope-1&quot;</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#D4D4D4">    </span><span style="color:#179FFF">(</span><span style="color:#569CD6">function</span><span style="color:#FFD700">(</span><span style="color:#FFD700">)</span><span style="color:#FFD700">{</span></span>
<span class="line"><span style="color:#569CD6">        var</span><span style="color:#9CDCFE"> scope</span><span style="color:#D4D4D4"> = </span><span style="color:#B5CEA8">2</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">two</span><span style="color:#D4D4D4"> = </span><span style="color:#CE9178">&quot;scope-2&quot;</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#D4D4D4">        </span><span style="color:#DA70D6">(</span><span style="color:#569CD6">function</span><span style="color:#179FFF">(</span><span style="color:#179FFF">)</span><span style="color:#179FFF">{</span></span>
<span class="line"><span style="color:#569CD6">            var</span><span style="color:#9CDCFE"> scope</span><span style="color:#D4D4D4"> = </span><span style="color:#B5CEA8">3</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">three</span><span style="color:#D4D4D4"> = </span><span style="color:#CE9178">&quot;scope-3&quot;</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#6A9955">            // scope-3 scope-2 scope-1 global-scope</span></span>
<span class="line"><span style="color:#9CDCFE">            console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#FFD700">(</span><span style="color:#DA70D6">[</span><span style="color:#9CDCFE">three</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">two</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">one</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">zero</span><span style="color:#DA70D6">]</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">join</span><span style="color:#DA70D6">(</span><span style="color:#CE9178">&quot; &quot;</span><span style="color:#DA70D6">)</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#9CDCFE">            console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#FFD700">(</span><span style="color:#9CDCFE">scope</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// 3</span></span>
<span class="line"><span style="color:#D4D4D4">        </span><span style="color:#179FFF">}</span><span style="color:#DA70D6">)</span><span style="color:#DA70D6">(</span><span style="color:#DA70D6">)</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#9CDCFE">        console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#DA70D6">(</span><span style="color:#569CD6">typeof</span><span style="color:#9CDCFE"> three</span><span style="color:#DA70D6">)</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// undefined</span></span>
<span class="line"><span style="color:#9CDCFE">        console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#DA70D6">(</span><span style="color:#9CDCFE">scope</span><span style="color:#DA70D6">)</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// 2</span></span>
<span class="line"><span style="color:#D4D4D4">    </span><span style="color:#FFD700">}</span><span style="color:#179FFF">)</span><span style="color:#179FFF">(</span><span style="color:#179FFF">)</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#9CDCFE">    console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#179FFF">(</span><span style="color:#569CD6">typeof</span><span style="color:#9CDCFE"> two</span><span style="color:#179FFF">)</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// undefined</span></span>
<span class="line"><span style="color:#9CDCFE">    console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#179FFF">(</span><span style="color:#9CDCFE">scope</span><span style="color:#179FFF">)</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// 1</span></span>
<span class="line"><span style="color:#DA70D6">}</span><span style="color:#FFD700">)</span><span style="color:#FFD700">(</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#9CDCFE">console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#FFD700">(</span><span style="color:#569CD6">typeof</span><span style="color:#9CDCFE"> one</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// undefined</span></span>
<span class="line"><span style="color:#9CDCFE">console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#FFD700">(</span><span style="color:#9CDCFE">scope</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// 0</span></span></code></pre>
<p>在最里层的函数中，各个变量都能被逐级遍历并输出。而倒数第二层的函数中，变量 <code>three</code> 无法遍历找到，所以输出了 <code>undefined</code> 。</p>
<p>举一个通俗点的例子，你准备要花钱买点东西时，会先摸摸自己的钱包，没了你可以找你爸要，你爸也没有就再找你爷爷，... 。而你爸没钱买东西时，他并不会来找你要。</p>
<h3>闭包</h3>
<p>在一个函数中，定义另一个函数，称为函数嵌套。函数的嵌套将形成一个<strong>闭包</strong>。</p>
<p>闭包与作用域链相辅相成，函数的嵌套在产生了链式关系的多个作用域的同时，也形成了一个闭包。</p>
<pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#569CD6">function</span><span style="color:#DCDCAA"> bind</span><span style="color:#FFD700">(</span><span style="color:#9CDCFE">func</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">target</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4"> </span><span style="color:#FFD700">{</span></span>
<span class="line"><span style="color:#C586C0">    return</span><span style="color:#569CD6"> function</span><span style="color:#DA70D6">(</span><span style="color:#DA70D6">)</span><span style="color:#D4D4D4"> </span><span style="color:#DA70D6">{</span></span>
<span class="line"><span style="color:#9CDCFE">        func</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">apply</span><span style="color:#179FFF">(</span><span style="color:#9CDCFE">target</span><span style="color:#D4D4D4">, </span><span style="color:#569CD6">arguments</span><span style="color:#179FFF">)</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#D4D4D4">    </span><span style="color:#DA70D6">}</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#FFD700">}</span></span></code></pre>
<p>那么怎么理解闭包呢？</p>
<ul>
<li>外部函数不能访问内嵌函数</li>
<li>外部函数也不能访问内嵌函数的参数和变量</li>
<li>而内嵌函数可以访问外部函数的参数和变量</li>
<li>换一个说法：内嵌函数包含了外部函数的作用域</li>
</ul>
<p>我们再看看之前讲述的作用域链的例子，这次从闭包的角度来理解下：</p>
<pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#569CD6">var</span><span style="color:#9CDCFE"> scope</span><span style="color:#D4D4D4"> = </span><span style="color:#B5CEA8">0</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">zero</span><span style="color:#D4D4D4"> = </span><span style="color:#CE9178">&quot;global-scope&quot;</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#FFD700">(</span><span style="color:#569CD6">function</span><span style="color:#DA70D6">(</span><span style="color:#DA70D6">)</span><span style="color:#DA70D6">{</span></span>
<span class="line"><span style="color:#569CD6">    var</span><span style="color:#9CDCFE"> scope</span><span style="color:#D4D4D4"> = </span><span style="color:#B5CEA8">1</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">one</span><span style="color:#D4D4D4"> = </span><span style="color:#CE9178">&quot;scope-1&quot;</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#D4D4D4">    </span><span style="color:#179FFF">(</span><span style="color:#569CD6">function</span><span style="color:#FFD700">(</span><span style="color:#FFD700">)</span><span style="color:#FFD700">{</span></span>
<span class="line"><span style="color:#569CD6">        var</span><span style="color:#9CDCFE"> scope</span><span style="color:#D4D4D4"> = </span><span style="color:#B5CEA8">2</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">two</span><span style="color:#D4D4D4"> = </span><span style="color:#CE9178">&quot;scope-2&quot;</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#D4D4D4">        </span><span style="color:#DA70D6">(</span><span style="color:#569CD6">function</span><span style="color:#179FFF">(</span><span style="color:#179FFF">)</span><span style="color:#179FFF">{</span></span>
<span class="line"><span style="color:#569CD6">            var</span><span style="color:#9CDCFE"> scope</span><span style="color:#D4D4D4"> = </span><span style="color:#B5CEA8">3</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">three</span><span style="color:#D4D4D4"> = </span><span style="color:#CE9178">&quot;scope-3&quot;</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#6A9955">            // scope-3 scope-2 scope-1 global-scope</span></span>
<span class="line"><span style="color:#9CDCFE">            console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#FFD700">(</span><span style="color:#DA70D6">[</span><span style="color:#9CDCFE">three</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">two</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">one</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">zero</span><span style="color:#DA70D6">]</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">join</span><span style="color:#DA70D6">(</span><span style="color:#CE9178">&quot; &quot;</span><span style="color:#DA70D6">)</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#9CDCFE">            console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#FFD700">(</span><span style="color:#9CDCFE">scope</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// 3</span></span>
<span class="line"><span style="color:#D4D4D4">        </span><span style="color:#179FFF">}</span><span style="color:#DA70D6">)</span><span style="color:#DA70D6">(</span><span style="color:#DA70D6">)</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#9CDCFE">        console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#DA70D6">(</span><span style="color:#569CD6">typeof</span><span style="color:#9CDCFE"> three</span><span style="color:#DA70D6">)</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// undefined</span></span>
<span class="line"><span style="color:#9CDCFE">        console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#DA70D6">(</span><span style="color:#9CDCFE">scope</span><span style="color:#DA70D6">)</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// 2</span></span>
<span class="line"><span style="color:#D4D4D4">    </span><span style="color:#FFD700">}</span><span style="color:#179FFF">)</span><span style="color:#179FFF">(</span><span style="color:#179FFF">)</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#9CDCFE">    console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#179FFF">(</span><span style="color:#569CD6">typeof</span><span style="color:#9CDCFE"> two</span><span style="color:#179FFF">)</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// undefined</span></span>
<span class="line"><span style="color:#9CDCFE">    console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#179FFF">(</span><span style="color:#9CDCFE">scope</span><span style="color:#179FFF">)</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// 1</span></span>
<span class="line"><span style="color:#DA70D6">}</span><span style="color:#FFD700">)</span><span style="color:#FFD700">(</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#9CDCFE">console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#FFD700">(</span><span style="color:#569CD6">typeof</span><span style="color:#9CDCFE"> one</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// undefined</span></span>
<span class="line"><span style="color:#9CDCFE">console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#FFD700">(</span><span style="color:#9CDCFE">scope</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4">; </span><span style="color:#6A9955">// 0</span></span></code></pre>
<p>最里层的函数能访问到其内部和外部定义的所有变量。而倒数第二层的函数无法访问到最里层的变量，同时，最里层的 <code>scope = 3</code> 这个赋值操作并没有对其外部的同名变量产生影响。</p>
<p>再换个角度来理解闭包：</p>
<ul>
<li>每次外部函数的调用，内嵌函数都会被创建一次</li>
<li>在它被创建时，外部函数的作用域（包括任何本地变量、参数等上下文），
会成为每个内嵌函数对象的内部状态的一部分，即使在外部函数执行完并退出后</li>
</ul>
<p>看下面的例子：</p>
<pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#569CD6">var</span><span style="color:#9CDCFE"> i</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">list</span><span style="color:#D4D4D4"> = </span><span style="color:#FFD700">[</span><span style="color:#FFD700">]</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#C586C0">for</span><span style="color:#D4D4D4"> </span><span style="color:#FFD700">(</span><span style="color:#9CDCFE">i</span><span style="color:#D4D4D4"> = </span><span style="color:#B5CEA8">0</span><span style="color:#D4D4D4">; </span><span style="color:#9CDCFE">i</span><span style="color:#D4D4D4"> </span><span style="color:#D4D4D4">&lt;</span><span style="color:#D4D4D4"> </span><span style="color:#B5CEA8">2</span><span style="color:#D4D4D4">; </span><span style="color:#9CDCFE">i</span><span style="color:#D4D4D4"> += </span><span style="color:#B5CEA8">1</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4"> </span><span style="color:#FFD700">{</span></span>
<span class="line"><span style="color:#9CDCFE">    list</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">push</span><span style="color:#DA70D6">(</span><span style="color:#569CD6">function</span><span style="color:#179FFF">(</span><span style="color:#179FFF">)</span><span style="color:#179FFF">{</span></span>
<span class="line"><span style="color:#9CDCFE">        console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#FFD700">(</span><span style="color:#9CDCFE">i</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#D4D4D4">    </span><span style="color:#179FFF">}</span><span style="color:#DA70D6">)</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#FFD700">}</span></span>
<span class="line"><span style="color:#9CDCFE">list</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">forEach</span><span style="color:#FFD700">(</span><span style="color:#569CD6">function</span><span style="color:#DA70D6">(</span><span style="color:#9CDCFE">func</span><span style="color:#DA70D6">)</span><span style="color:#DA70D6">{</span></span>
<span class="line"><span style="color:#DCDCAA">  func</span><span style="color:#179FFF">(</span><span style="color:#179FFF">)</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#DA70D6">}</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4">;</span></span></code></pre>
<p>我们将得到两次 &quot;2&quot; ，而不是预期的 &quot;1&quot; 和 &quot;2&quot; ，这是因为在 <code>list</code> 中的两个函数访问的变量 <code>i</code> 都是其上一层作用域的同一个变量。</p>
<p>我们改动下代码，以利用闭包来解决这个问题：</p>
<pre class="shiki dark-plus" style="background-color:#1E1E1E;color:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#569CD6">var</span><span style="color:#9CDCFE"> i</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">list</span><span style="color:#D4D4D4"> = </span><span style="color:#FFD700">[</span><span style="color:#FFD700">]</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#C586C0">for</span><span style="color:#D4D4D4"> </span><span style="color:#FFD700">(</span><span style="color:#9CDCFE">i</span><span style="color:#D4D4D4"> = </span><span style="color:#B5CEA8">0</span><span style="color:#D4D4D4">; </span><span style="color:#9CDCFE">i</span><span style="color:#D4D4D4"> </span><span style="color:#D4D4D4">&lt;</span><span style="color:#D4D4D4"> </span><span style="color:#B5CEA8">2</span><span style="color:#D4D4D4">; </span><span style="color:#9CDCFE">i</span><span style="color:#D4D4D4"> += </span><span style="color:#B5CEA8">1</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4"> </span><span style="color:#FFD700">{</span></span>
<span class="line"><span style="color:#9CDCFE">    list</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">push</span><span style="color:#DA70D6">(</span><span style="color:#179FFF">(</span><span style="color:#569CD6">function</span><span style="color:#FFD700">(</span><span style="color:#9CDCFE">j</span><span style="color:#FFD700">)</span><span style="color:#FFD700">{</span></span>
<span class="line"><span style="color:#C586C0">        return</span><span style="color:#569CD6"> function</span><span style="color:#DA70D6">(</span><span style="color:#DA70D6">)</span><span style="color:#DA70D6">{</span></span>
<span class="line"><span style="color:#9CDCFE">            console</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">log</span><span style="color:#179FFF">(</span><span style="color:#9CDCFE">j</span><span style="color:#179FFF">)</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#D4D4D4">        </span><span style="color:#DA70D6">}</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#D4D4D4">    </span><span style="color:#FFD700">}</span><span style="color:#179FFF">)</span><span style="color:#179FFF">(</span><span style="color:#9CDCFE">i</span><span style="color:#179FFF">)</span><span style="color:#DA70D6">)</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#FFD700">}</span></span>
<span class="line"><span style="color:#9CDCFE">list</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">forEach</span><span style="color:#FFD700">(</span><span style="color:#569CD6">function</span><span style="color:#DA70D6">(</span><span style="color:#9CDCFE">func</span><span style="color:#DA70D6">)</span><span style="color:#DA70D6">{</span></span>
<span class="line"><span style="color:#DCDCAA">  func</span><span style="color:#179FFF">(</span><span style="color:#179FFF">)</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#DA70D6">}</span><span style="color:#FFD700">)</span><span style="color:#D4D4D4">;</span></span></code></pre>
<p>外层的“立即执行函数”接收了一个参数变量 <code>i</code> ，在其函数内以参数 <code>j</code> 的形式存在，它与被返回的内层函数中的名称 <code>j</code> 指向同一个引用。外层函数执行并退出后，参数 <code>j</code> （此时它的值为 <code>i</code> 的当前值）成为了其内层函数的状态的一部分被保存了下来。</p></article></main><footer class="page-footer"><hr/><div class="bio"><img class="bio-avatar" src="/assets/a0736d0e7e8d470e.png"/><div class="bio-content">Personal blog by <a href="/">Shenwei Wang</a>.<br/>Writing code, raising kid, exploring the world.</div></div></footer></body></html>