<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.75f38c4997591d90ecdc.css">:root{--reach-skip-nav:1}[data-reach-skip-nav-link]{border:0;clip:rect(0 0 0 0);height:1px;width:1px;margin:-1px;padding:0;overflow:hidden;position:absolute}[data-reach-skip-nav-link]:focus{padding:1rem;position:fixed;top:10px;left:10px;background:#fff;z-index:1;width:auto;height:auto;clip:auto}p.figure-caption{text-align:center;opacity:.6;font-size:87.5%;margin-top:-14px;font-style:italic;width:-webkit-fit-content;width:-moz-fit-content;width:fit-content;max-width:90%;margin-left:auto;margin-right:auto;border-bottom:1px solid #ccc;padding-left:28px;padding-right:28px;padding-bottom:7px}hr.divider{border:none;font-size:150%;letter-spacing:.6em;margin-bottom:42px;text-align:center}hr.divider:before{content:"..."}footer>hr{margin-bottom:16px}a[role=button]{cursor:pointer}.highlight{border-left:3px solid #cc4c33;padding-left:13px;padding-right:16px;margin-left:-16px;margin-right:-16px}[data-reach-skip-nav-link]{display:none}.search-mark{box-shadow:0 1px 0 0 currentColor}.slide-ignore-end,.slide-ignore-start,.slide-only,.slide-page-end,.slide-page-start,.slide-title{display:none}.slide-canvas{display:flex;justify-content:center;align-items:center;height:calc(100vh - 64px)}.slide-canvas>section :first-child{margin-top:0}.slide-canvas>section :last-child{margin-bottom:0}.slide-canvas .slide-only{display:block}.slide-title-page{font-family:Montserrat,sans-serif;font-size:32px;text-align:center}.slide-canvas .prism-code{margin-left:0;margin-right:0;border-radius:10px}body.headless :not(article)>header,body.headless main+footer{display:none}@media screen and (min-width:40em){h1>a{font-size:32px}.prism-code{border-radius:10px}}.slide-bounce-left{animation:bounce-left .2s ease 0ms 4 alternate}.slide-bounce-right{animation:bounce-right .2s ease 0ms 4 alternate}@keyframes bounce-left{0%{transform:translateX(0)}to{transform:translateX(32px)}}@keyframes bounce-right{0%{transform:translateX(0)}to{transform:translateX(-32px)}}</style><meta name="generator" content="Gatsby 2.24.10"/><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><title data-react-helmet="true">实现一个 JavaScript Sandbox | WeAreOutMan</title><link data-react-helmet="true" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&amp;family=Montserrat:wght@700;900&amp;display=swap"/><meta data-react-helmet="true" property="og:image" content="https://www.wangshenwei.com/static/2b467d8e9e1c0d3a8662ef8c8a223a18/88b72/avatar.png"/><meta data-react-helmet="true" name="description" content="在某些项目中，特别是低代码平台、在线代码编辑器等，我们往往需要提供一个沙盒环境，让用户可以自行编写并运行 JavaScript 代码。这个沙盒需要提供一些平台内置 API…"/><meta data-react-helmet="true" property="og:title" content="实现一个 JavaScript Sandbox"/><meta data-react-helmet="true" property="og:description" content="在某些项目中，特别是低代码平台、在线代码编辑器等，我们往往需要提供一个沙盒环境，让用户可以自行编写并运行 JavaScript 代码。这个沙盒需要提供一些平台内置 API…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:creator" content="Shenwei Wang"/><meta data-react-helmet="true" name="twitter:title" content="实现一个 JavaScript Sandbox"/><meta data-react-helmet="true" name="twitter:description" content="在某些项目中，特别是低代码平台、在线代码编辑器等，我们往往需要提供一个沙盒环境，让用户可以自行编写并运行 JavaScript 代码。这个沙盒需要提供一些平台内置 API…"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><link rel="icon" href="/favicon-32x32.png?v=2b467d8e9e1c0d3a8662ef8c8a223a18"/><link rel="manifest" href="/manifest.webmanifest"/><link as="script" rel="preload" href="/webpack-runtime-4d61d6f36b696a0865b2.js"/><link as="script" rel="preload" href="/framework-42897c4e770e3c8b7b7b.js"/><link as="script" rel="preload" href="/styles-2d4804b503525347efbe.js"/><link as="script" rel="preload" href="/app-bc0fa8565171cdc976ba.js"/><link as="script" rel="preload" href="/commons-c09e6334871a95b3802a.js"/><link as="script" rel="preload" href="/component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js-e132334849c54914e889.js"/><link as="fetch" rel="preload" href="/page-data/implementing-a-javascript-sandbox/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/static/d/2744905544.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/static/d/3090755652.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/static/d/386998304.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/static/d/764694655.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>(function() { try {
  var mode = localStorage.getItem('theme-ui-color-mode');
  if (!mode) return
  document.body.classList.add('theme-ui-' + mode);
} catch (e) {} })();</script><div id="___gatsby"><style data-emotion-css="wnkb0j">body{--theme-ui-colors-text:var(--theme-ui-colors-text,hsl(10,20%,20%));--theme-ui-colors-background:var(--theme-ui-colors-background,hsl(10,10%,98%));--theme-ui-colors-primary:var(--theme-ui-colors-primary,hsl(10,80%,50%));--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,hsl(10,60%,50%));--theme-ui-colors-highlight:var(--theme-ui-colors-highlight,hsl(10,40%,90%));--theme-ui-colors-purple:var(--theme-ui-colors-purple,hsl(250,60%,30%));--theme-ui-colors-muted:var(--theme-ui-colors-muted,hsl(10,20%,94%));--theme-ui-colors-gray:var(--theme-ui-colors-gray,hsl(10,20%,50%));--theme-ui-colors-inline-code:var(--theme-ui-colors-inline-code,hsl(10,60%,50%));color:var(--theme-ui-colors-text,hsl(10,20%,20%));background-color:var(--theme-ui-colors-background,hsl(10,10%,98%));}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,hsl(210,50%,96%));--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,hsl(230,25%,18%));--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,hsla(230,20%,0%,20%));--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,rgb(242,95,92));--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,hsl(10,80%,50%));--theme-ui-colors-inline-code:var(--theme-ui-colors-modes-dark-inline-code,hsl(290,100%,80%));}</style><style data-emotion-css="jr3v97">*{box-sizing:border-box;}body{margin:0;font-family:'Merriweather','Georgia',serif;line-height:1.75;font-weight:400;font-size:16px;}</style><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="628fci">.css-628fci{font-family:'Merriweather','Georgia',serif;line-height:1.75;font-weight:400;font-size:16px;}</style><div class="css-628fci"><header><style data-emotion-css="19seewt">.css-19seewt{color:var(--theme-ui-colors-primary,hsl(10,80%,50%));-webkit-text-decoration:none;text-decoration:none;box-shadow:0 1px 0 0 currentColor;}.css-19seewt:hover{color:var(--theme-ui-colors-secondary,hsl(10,60%,50%));}</style><a class="css-19seewt" href="#reach-skip-nav" data-reach-skip-link="" data-reach-skip-nav-link="">Skip to content</a><style data-emotion-css="ckq4zy">.css-ckq4zy{max-width:704px;margin-left:auto;margin-right:auto;padding-left:16px;padding-right:16px;padding-top:32px;}</style><div class="css-ckq4zy"><style data-emotion-css="pcqfzb">.css-pcqfzb{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin-bottom:8px;}</style><div class="css-pcqfzb"><style data-emotion-css="1qd1r5f">.css-1qd1r5f{margin-top:0;margin-bottom:0;}</style><style data-emotion-css="dkbyqt">.css-dkbyqt{font-family:Montserrat,sans-serif;font-weight:700;line-height:1.25;font-size:20px;margin-top:0;margin-bottom:0;}@media screen and (min-width:40em){.css-dkbyqt{font-size:24px;}}</style><p class="css-dkbyqt"><style data-emotion-css="15vs81m">.css-15vs81m{box-shadow:none;-webkit-text-decoration:none;text-decoration:none;color:var(--theme-ui-colors-primary,hsl(10,80%,50%));}</style><style data-emotion-css="14rk83l">.css-14rk83l{color:var(--theme-ui-colors-primary,hsl(10,80%,50%));-webkit-text-decoration:none;text-decoration:none;box-shadow:0 1px 0 0 currentColor;box-shadow:none;-webkit-text-decoration:none;text-decoration:none;color:var(--theme-ui-colors-primary,hsl(10,80%,50%));}.css-14rk83l:hover{color:var(--theme-ui-colors-secondary,hsl(10,60%,50%));}</style><a class="css-14rk83l" href="/">WeAreOutMan</a></p><style data-emotion-css="135vz7z">.css-135vz7z{box-shadow:none;-webkit-text-decoration:none;text-decoration:none;}</style><style data-emotion-css="o63vl5">.css-o63vl5{color:var(--theme-ui-colors-primary,hsl(10,80%,50%));-webkit-text-decoration:none;text-decoration:none;box-shadow:0 1px 0 0 currentColor;box-shadow:none;-webkit-text-decoration:none;text-decoration:none;}.css-o63vl5:hover{color:var(--theme-ui-colors-secondary,hsl(10,60%,50%));}</style><a role="button" class="css-o63vl5">Dark</a></div></div></header><div id="reach-skip-nav" data-reach-skip-nav-content=""></div><div><style data-emotion-css="b93ooj">.css-b93ooj{max-width:704px;margin-left:auto;margin-right:auto;padding-left:16px;padding-right:16px;padding-top:32px;padding-bottom:32px;}</style><div class="css-b93ooj"><main><article><header><style data-emotion-css="17d3iyk">.css-17d3iyk{font-family:Montserrat,sans-serif;font-weight:900;line-height:1.25;font-size:32px;-webkit-letter-spacing:-0.03em;-moz-letter-spacing:-0.03em;-ms-letter-spacing:-0.03em;letter-spacing:-0.03em;margin-top:16px;}@media screen and (min-width:40em){.css-17d3iyk{font-size:40px;}}</style><h1 class="css-17d3iyk">实现一个 JavaScript Sandbox</h1><style data-emotion-css="1h1xv8c">.css-1h1xv8c{font-size:14px;margin-top:-16px;margin-bottom:16px;}</style><style data-emotion-css="1w2ean9">.css-1w2ean9{margin-top:32px;margin-bottom:32px;font-size:14px;margin-top:-16px;margin-bottom:16px;}</style><p class="css-1w2ean9">July 06, 2024</p></header><section><style data-emotion-css="zitybv">.css-zitybv{margin-top:32px;margin-bottom:32px;}</style><p class="css-zitybv">在某些项目中，特别是低代码平台、在线代码编辑器等，我们往往需要提供一个沙盒环境，让用户可以自行编写并运行 JavaScript 代码。这个沙盒需要提供一些平台内置 API 的访问，同时还需要限制用户代码的访问权限，以防止用户恶意操作。</p><p class="css-zitybv">如果不考虑安全性等因素，要实现运行用户或者其他第三方编写的 JavaScript 代码并不难，只需要使用 <style data-emotion-css="m301d5">.css-m301d5{font-family:Menlo,monospace;color:var(--theme-ui-colors-inline-code,hsl(10,60%,50%));background-color:var(--theme-ui-colors-muted,hsl(10,20%,94%));padding-left:3px;padding-right:3px;}</style><code class="css-m301d5">eval</code> 函数或者 <code class="css-m301d5">Function</code> 构造函数即可。但考虑下面的代码<sup><a href="https://github.com/nyariv/SandboxJS" class="css-19seewt">[<!-- -->1<!-- -->]</a></sup>：</p><style data-emotion-css="1v64iiv">.css-1v64iiv{font-family:Menlo,monospace;font-size:14px;padding:16px;color:#9CDCFE;background-color:#1E1E1E;overflow:auto;margin-bottom:32px;margin-left:-16px;margin-right:-16px;}.css-1v64iiv .comment,.css-1v64iiv .prolog,.css-1v64iiv .doctype,.css-1v64iiv .cdata,.css-1v64iiv .punctuation,.css-1v64iiv .operator,.css-1v64iiv .entity,.css-1v64iiv .url{color:var(--theme-ui-colors-gray,hsl(10,20%,50%));}.css-1v64iiv .comment{color:rgb(106,153,85);}.css-1v64iiv .property,.css-1v64iiv .tag,.css-1v64iiv .boolean,.css-1v64iiv .number,.css-1v64iiv .constant,.css-1v64iiv .symbol,.css-1v64iiv .deleted,.css-1v64iiv .function,.css-1v64iiv .class-name,.css-1v64iiv .regex,.css-1v64iiv .important,.css-1v64iiv .variable{color:var(--theme-ui-colors-purple,hsl(250,60%,30%));}.css-1v64iiv .atrule,.css-1v64iiv .attr-value,.css-1v64iiv .keyword{color:var(--theme-ui-colors-primary,hsl(10,80%,50%));}.css-1v64iiv .selector,.css-1v64iiv .attr-name,.css-1v64iiv .string,.css-1v64iiv .char,.css-1v64iiv .builtin,.css-1v64iiv .inserted{color:var(--theme-ui-colors-secondary,hsl(10,60%,50%));}.css-1v64iiv .property,.css-1v64iiv .title,.css-1v64iiv .important,.css-1v64iiv .boolean,.css-1v64iiv .regex{color:inherit;}.css-1v64iiv .regex{color:var(--theme-ui-colors-secondary,hsl(10,60%,50%));}.css-1v64iiv code{color:inherit;}.css-1v64iiv .prolog{color:rgb(0,0,128);}.css-1v64iiv .builtin,.css-1v64iiv .changed,.css-1v64iiv .keyword{color:rgb(86,156,214);}.css-1v64iiv .number,.css-1v64iiv .inserted{color:rgb(181,206,168);}.css-1v64iiv .constant{color:rgb(100,102,149);}.css-1v64iiv .attr-name,.css-1v64iiv .variable{color:rgb(156,220,254);}.css-1v64iiv .deleted,.css-1v64iiv .string,.css-1v64iiv .attr-value{color:rgb(206,145,120);}.css-1v64iiv .selector{color:rgb(215,186,125);}.css-1v64iiv .tag{color:rgb(86,156,214);}.css-1v64iiv .punctuation,.css-1v64iiv .operator{color:rgb(212,212,212);}.css-1v64iiv .punctuation{color:#808080;}.css-1v64iiv .function{color:rgb(220,220,170);}.css-1v64iiv .class-name{color:rgb(78,201,176);}.css-1v64iiv .char{color:rgb(209,105,105);}.css-1v64iiv .highlight{background:hsla(0,0%,40%,.5);}</style><style data-emotion-css="a7hg0h">.css-a7hg0h{font-family:Menlo,monospace;color:#9cdcfe;font-size:14px;}</style><style data-emotion-css="194ank4">.css-194ank4{font-family:Menlo,monospace;font-size:14px;padding:16px;color:#9CDCFE;background-color:#1E1E1E;overflow:auto;margin-bottom:32px;margin-left:-16px;margin-right:-16px;font-family:Menlo,monospace;color:#9cdcfe;font-size:14px;}.css-194ank4 .comment,.css-194ank4 .prolog,.css-194ank4 .doctype,.css-194ank4 .cdata,.css-194ank4 .punctuation,.css-194ank4 .operator,.css-194ank4 .entity,.css-194ank4 .url{color:var(--theme-ui-colors-gray,hsl(10,20%,50%));}.css-194ank4 .comment{color:rgb(106,153,85);}.css-194ank4 .property,.css-194ank4 .tag,.css-194ank4 .boolean,.css-194ank4 .number,.css-194ank4 .constant,.css-194ank4 .symbol,.css-194ank4 .deleted,.css-194ank4 .function,.css-194ank4 .class-name,.css-194ank4 .regex,.css-194ank4 .important,.css-194ank4 .variable{color:var(--theme-ui-colors-purple,hsl(250,60%,30%));}.css-194ank4 .atrule,.css-194ank4 .attr-value,.css-194ank4 .keyword{color:var(--theme-ui-colors-primary,hsl(10,80%,50%));}.css-194ank4 .selector,.css-194ank4 .attr-name,.css-194ank4 .string,.css-194ank4 .char,.css-194ank4 .builtin,.css-194ank4 .inserted{color:var(--theme-ui-colors-secondary,hsl(10,60%,50%));}.css-194ank4 .property,.css-194ank4 .title,.css-194ank4 .important,.css-194ank4 .boolean,.css-194ank4 .regex{color:inherit;}.css-194ank4 .regex{color:var(--theme-ui-colors-secondary,hsl(10,60%,50%));}.css-194ank4 code{color:inherit;}.css-194ank4 .prolog{color:rgb(0,0,128);}.css-194ank4 .builtin,.css-194ank4 .changed,.css-194ank4 .keyword{color:rgb(86,156,214);}.css-194ank4 .number,.css-194ank4 .inserted{color:rgb(181,206,168);}.css-194ank4 .constant{color:rgb(100,102,149);}.css-194ank4 .attr-name,.css-194ank4 .variable{color:rgb(156,220,254);}.css-194ank4 .deleted,.css-194ank4 .string,.css-194ank4 .attr-value{color:rgb(206,145,120);}.css-194ank4 .selector{color:rgb(215,186,125);}.css-194ank4 .tag{color:rgb(86,156,214);}.css-194ank4 .punctuation,.css-194ank4 .operator{color:rgb(212,212,212);}.css-194ank4 .punctuation{color:#808080;}.css-194ank4 .function{color:rgb(220,220,170);}.css-194ank4 .class-name{color:rgb(78,201,176);}.css-194ank4 .char{color:rgb(209,105,105);}.css-194ank4 .highlight{background:hsla(0,0%,40%,.5);}</style><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">filter</span><span class="token punctuation">.</span><span class="token method function property-access">constructor</span><span class="token punctuation">(</span><span class="token string">&quot;alert(&#x27;jailbreak&#x27;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div></pre><p class="css-zitybv">这样的代码看上去人畜无害，没有直接访问任何全局对象，却可以让你的网页弹出一个恼人的对话框。事实上，攻击者可以只使用6种符号即可组合构造任意代码 <sup><a href="https://jsfuck.com/" class="css-19seewt">[<!-- -->2<!-- -->]</a></sup>：<code class="css-m301d5">(</code>, <code class="css-m301d5">)</code>, <code class="css-m301d5">[</code>, <code class="css-m301d5">]</code>, <code class="css-m301d5">!</code> 和 <code class="css-m301d5">+</code>。</p><p class="css-zitybv">因此我们有必要构造一个沙盒环境，根据业务需求，限制用户代码对特定对象的访问，防止恶意操作。</p><p class="css-zitybv">既然是沙盒环境，我们还可以跳脱传统 JavaScript 的限制，扩展它的能力，例如：</p><ul class="css-0"><li class="css-0">支持最新的 ECMAScript 特性</li><li class="css-0">支持 TypeScript</li><li class="css-0">免编译执行</li></ul><p class="css-zitybv">你没看错，我们可以在老旧浏览器中免编译执行包含最新特性的 JavaScript 甚至是 TypeScript。</p><p class="css-zitybv">除此之外，基本的开发体验也是必不可少的，包括：</p><ul class="css-0"><li class="css-0">单步/断点调试</li><li class="css-0">统计测试覆盖率</li></ul><p class="css-zitybv"><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1380px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:43.76811594202899%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAcepBDD/xAAVEAEBAAAAAAAAAAAAAAAAAAAQQf/aAAgBAQABBQJp/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGRAAAQUAAAAAAAAAAAAAAAAAAAERICEx/9oACAEBAAE/IbcXYv/aAAwDAQACAAMAAAAQMw//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAaEAEAAgMBAAAAAAAAAAAAAAABABEgIUGB/9oACAEBAAE/EDqV5LlnZgZ//9k=&#x27;);background-size:cover;display:block"></span>
  <style data-emotion-css="9whsf3">.css-9whsf3{max-width:100%;}</style><img class="gatsby-resp-image-image css-9whsf3" alt="Function debugging screenshot" title="Function debugging screenshot" src="/static/7007a6b838b8a319229b740b723fa5c9/89b2d/function-screenshot.jpg" srcSet="/static/7007a6b838b8a319229b740b723fa5c9/8d48c/function-screenshot.jpg 345w,/static/7007a6b838b8a319229b740b723fa5c9/15ec7/function-screenshot.jpg 690w,/static/7007a6b838b8a319229b740b723fa5c9/89b2d/function-screenshot.jpg 1380w,/static/7007a6b838b8a319229b740b723fa5c9/33042/function-screenshot.jpg 2070w,/static/7007a6b838b8a319229b740b723fa5c9/45df8/function-screenshot.jpg 2760w,/static/7007a6b838b8a319229b740b723fa5c9/23d91/function-screenshot.jpg 3556w" sizes="(max-width: 1380px) 100vw, 1380px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p class="figure-caption css-zitybv">优维低代码平台的函数调试界面</p><style data-emotion-css="gdscko">.css-gdscko{font-family:Montserrat,sans-serif;font-weight:700;line-height:1.25;font-size:24px;}@media screen and (min-width:40em){.css-gdscko{font-size:32px;}}</style><style data-emotion-css="1sg5i1s">.css-1sg5i1s{pointer-events:painted;font-family:Montserrat,sans-serif;font-weight:700;line-height:1.25;font-size:24px;}.css-1sg5i1s a{visibility:hidden;}.css-1sg5i1s:hover a{visibility:visible;}@media screen and (min-width:40em){.css-1sg5i1s{font-size:32px;}}</style><h2 id="理论" class="css-1sg5i1s"><style data-emotion-css="1minv35">.css-1minv35{margin-left:-20px;padding-right:4px;color:var(--theme-ui-colors-primary,hsl(10,80%,50%));}</style><a href="#理论" aria-label="理论" class="css-1minv35"><svg viewBox="0 0 16 16" width="16" height="16" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>理论</h2><p class="css-zitybv">要实现一个沙盒环境，在一定程度上等同于实现一门编程语言，当然我们这里不需要重现设计一门新的编程语言，只需关注实现。</p><p class="css-zitybv">编程语言的实现一般包括三个阶段：</p><ol class="css-0"><li class="css-0">词法分析（Lexical Analysis）</li><li class="css-0">语法分析（Syntax Analysis）</li><li class="css-0">语义分析（Semantic Analysis）</li></ol><p class="css-zitybv">其实这个过程也适用于自然语言。例如，当我们阅读一篇文章时：</p><ol class="css-0"><li class="css-0">我们首先识别出一个个的词语及符号，这是词法分析；</li><li class="css-0">然后识别语法，例如主/谓/宾，并组成特定的句子，这是语法分析；</li><li class="css-0">最后理解文章整体表达的思想，这是语义分析。</li></ol><p class="css-zitybv">对于编程语言，词法分析将源代码分解为 tokens，语法分析将 tokens 组合成抽象语法树（Abstract Syntax Tree）。根据语义分析阶段的不同，可以将编程语言的实现分为解释型和编译型。它们的区别是，在得到抽象语法树后，解释型语言直接遍历并执行抽象语法树，而编译型语言将抽象语法树转换为机器码后再执行。</p><pre class="prism-code language-css-a7hg0h css-194ank4"><div class="token-line"><span class="token plain">Source ──&gt; Tokens ───&gt; AST ───&gt; Behavior</span></div><div class="token-line"><span class="token plain">    (Lexer)    (Parser) │ (Interpreter)</span></div><div class="token-line"><span class="token plain">                        │</span></div><div class="token-line"><span class="token plain">             (Compiler) └─ ───&gt; Machine Code</span></div></pre><p class="css-zitybv">编译型语言的优势在于执行效率高，因为编译优化后得到的是机器码可以直接交给 CPU 执行；而解释型语言的优势在于开发效率高，同时可以支持运行时动态代码执行，因为它不需要额外的编译过程。通常支持 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval" class="css-19seewt"><code class="css-m301d5">eval()</code></a> 方法的编程语言都是解释型语言，例如 JavaScript / Python / PHP。</p><p class="css-zitybv">现代浏览器的 JavaScript 引擎通常已经不是纯粹的解释器，例如 Google V8 采用了 JIT（<a href="https://zh.wikipedia.org/zh-cn/%E5%8D%B3%E6%97%B6%E7%BC%96%E8%AF%91" class="css-19seewt">Just-In-Time</a>）编译器，它会在运行时阶段将解释执行的代码提前编译为<em class="css-0">字节码</em>（注意它和<em class="css-0">真编译型语言</em>转换的<em class="css-0">机器码</em>有所不同）以提高执行效率。</p><p class="css-zitybv">我们这里的场景只能选择使用解释器。</p><h2 id="实现" class="css-1sg5i1s"><a href="#实现" aria-label="实现" class="css-1minv35"><svg viewBox="0 0 16 16" width="16" height="16" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h2><p class="css-zitybv">现在我们开始动手编码，JavaScript 的词法和语法分析已经非常成熟，比如我们可以直接使用 <code class="css-m301d5">@babel/parser</code>：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token keyword module">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> parseExpression </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&quot;@babel/parser&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><style data-emotion-css="1baulvz">.css-1baulvz{display:inline-block;}</style><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 为简单起见，这里只解析表达式</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">parseExpression</span><span class="token punctuation">(</span><span class="token plain">source</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 使用 estree 格式的 AST https://github.com/estree/estree</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    plugins</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&quot;estree&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre><p class="css-zitybv">需要我们自己实现的主要是语义分析部分，即：如何遍历解释并执行抽象语法树。我们可以参考 <a href="https://tc39.es/ecma262/" class="css-19seewt">ECMAScript 官方规范</a>来实现，先假设我们仅支持 <em class="css-0">Literal</em> 节点（字符串、数字、布尔等），这非常简单：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">interpret</span><span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Evaluate</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&quot;Literal&quot;</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">return</span><span class="token plain"> node</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword module">default</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">throw</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Unsupported node type: </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">node</span><span class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation">type</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function maybe-class-name">Evaluate</span><span class="token punctuation">(</span><span class="token plain">ast</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre><p class="css-zitybv">这样我们就可以解释并执行一个简单的表达式了：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token function">interpret</span><span class="token punctuation">(</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;42&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 42</span></div></pre><p class="css-zitybv">接来我们再支持下二元表达式 <em class="css-0">BinaryExpression</em>：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token keyword">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&quot;BinaryExpression&quot;</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// https://tc39.es/ecma262/#sec-evaluatestringornumericbinaryexpression</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> leftValue </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function maybe-class-name">Evaluate</span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">.</span><span class="token property-access">left</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> rightValue </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function maybe-class-name">Evaluate</span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">.</span><span class="token property-access">right</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function maybe-class-name">ApplyStringOrNumericBinaryOperator</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      leftValue</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      node</span><span class="token punctuation">.</span><span class="token property-access">operator</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      rightValue</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> result</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// case &quot;Literal&quot;:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">ApplyStringOrNumericBinaryOperator</span><span class="token punctuation">(</span><span class="token parameter">leftValue</span><span class="token parameter punctuation">,</span><span class="token parameter"> operator</span><span class="token parameter punctuation">,</span><span class="token parameter"> rightValue</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">operator</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&quot;+&quot;</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> leftValue </span><span class="token operator">+</span><span class="token plain"> rightValue</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&quot;-&quot;</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> leftValue </span><span class="token operator">-</span><span class="token plain"> rightValue</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&quot;/&quot;</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> leftValue </span><span class="token operator">/</span><span class="token plain"> rightValue</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&quot;*&quot;</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> leftValue </span><span class="token operator">*</span><span class="token plain"> rightValue</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">throw</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Unsupported binary operator \`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">operator</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">\`</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre><p class="css-zitybv">现在我们已经可以进行四则运算了：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token function">interpret</span><span class="token punctuation">(</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;42 + 23&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 65</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">interpret</span><span class="token punctuation">(</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;(42 + 23) / 5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 13</span></div></pre><p class="css-zitybv">假设我们要为沙盒环境再提供一个内置 API <code class="css-m301d5">fibonacci(n)</code> 以获得第 n 个斐波那契数，为此我们需要支持 <em class="css-0">CallExpression</em> 和 <em class="css-0">Identifier</em>：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token keyword">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&quot;CallExpression&quot;</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> func </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function maybe-class-name">Evaluate</span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">.</span><span class="token property-access">callee</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function maybe-class-name">EvaluateCall</span><span class="token punctuation">(</span><span class="token plain">func</span><span class="token punctuation">,</span><span class="token plain"> node</span><span class="token punctuation">.</span><span class="token property-access">arguments</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;fibonacci&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">return</span><span class="token plain"> n </span><span class="token operator">&lt;=</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> n </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token plain">n</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token plain">n</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">throw</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Unknown identifier: </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">node</span><span class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// case &quot;BinaryExpression&quot;:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// https://tc39.es/ecma262/#sec-evaluatecall</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">EvaluateCall</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token parameter punctuation">,</span><span class="token parameter"> args</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> argList </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function maybe-class-name">ArgumentListEvaluation</span><span class="token punctuation">(</span><span class="token plain">args</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> func</span><span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> argList</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> result</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// https://tc39.es/ecma262/#sec-runtime-semantics-argumentlistevaluation</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">ArgumentListEvaluation</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> array </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">const</span><span class="token plain"> arg </span><span class="token keyword">of</span><span class="token plain"> args</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    array</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token function maybe-class-name">Evaluate</span><span class="token punctuation">(</span><span class="token plain">arg</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> array</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre><p class="css-zitybv">现在我们可以拿到指定的第 n 个斐波那契数：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token function">interpret</span><span class="token punctuation">(</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;fibonacci((42 + 23) / 5)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 233</span></div></pre><p class="css-zitybv">继续遵循 <a href="https://tc39.es/ecma262/" class="css-19seewt">ECMA-262</a> 语言规范，我们可以按照实际需求，选择性地逐步实现更多的语法能力，本文不再赘述。</p><p class="css-zitybv">由于代码执行的每个环节都由我们控制，所以我们可以轻松地限制用户代码对特定对象的访问。</p><h2 id="调试" class="css-1sg5i1s"><a href="#调试" aria-label="调试" class="css-1minv35"><svg viewBox="0 0 16 16" width="16" height="16" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调试</h2><p class="css-zitybv">前面提到，良好的开发体验也必不可少，其中最重要的首先是单步/断点调试。由于沙盒中代码的执行不再是浏览器直接执行的，因此无法使用浏览器的调试工具，需要我们自己实现。</p><p class="css-zitybv">断点调试本质上是中断代码的执行，但 JavaScript 是单线程的，看上去我们无法在应用层将一个同步的代码变成异步、可中断的代码，但实际上可以找到解决办法。</p><p class="css-zitybv">“中断代码的执行”正是<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function*" class="css-19seewt">生成器函数</a>做的事。日常开发中，很少有人会使用它，但它所支持的按需暂停和恢复执行的特性，恰好符合实现断点调试的需求。</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token keyword">function</span><span class="token operator">*</span><span class="token plain"> </span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">yield</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> gen </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">gen</span><span class="token punctuation">.</span><span class="token method function property-access">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// hello</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">gen</span><span class="token punctuation">.</span><span class="token method function property-access">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// world</span></div></pre><p class="css-zitybv">同时，我们可以让代码在调试执行时，是异步、可中断的，而在正常执行时，依然是同步的。</p><p class="css-zitybv">在我们的解释器中，可以先将源代码构造为一个包含 <code class="css-m301d5">yield</code> 断点的生成器中间函数，普通调用时，使用 <code class="css-m301d5">unwind</code> 同步展开生成的迭代器，因此该代码依然是同步执行的，而在调试模式下，直接返回生成的迭代器，这样就可以实现断点调试了：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token keyword">function</span><span class="token operator">*</span><span class="token plain"> </span><span class="token function">intermediate_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">yield</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token number">42</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">normal_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">unwind</span><span class="token punctuation">(</span><span class="token function">intermediate_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">debugger_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">intermediate_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">unwind</span><span class="token punctuation">(</span><span class="token parameter">iterator</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> done</span><span class="token punctuation">,</span><span class="token plain"> value </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> iterator</span><span class="token punctuation">.</span><span class="token method function property-access">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">done</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> value</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre><p class="css-zitybv">改造后的解释器代码大概如下：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">interpret</span><span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">function</span><span class="token operator">*</span><span class="token plain"> </span><span class="token function maybe-class-name">Evaluate</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">yield</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 断点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&quot;CallExpression&quot;</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 代理 Evaluate 遍历所生成的迭代器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> func </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">yield</span><span class="token operator">*</span><span class="token plain"> </span><span class="token function maybe-class-name">Evaluate</span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">.</span><span class="token property-access">callee</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">yield</span><span class="token operator">*</span><span class="token plain"> </span><span class="token function maybe-class-name">EvaluateCall</span><span class="token punctuation">(</span><span class="token plain">func</span><span class="token punctuation">,</span><span class="token plain"> node</span><span class="token punctuation">.</span><span class="token property-access">arguments</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre><p class="css-zitybv">调试器的启动和步进的实现就很简单了：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token keyword">let</span><span class="token plain"> iterator</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">start</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  iterator </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">interpret</span><span class="token punctuation">(</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token plain">code</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">step</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  iterator</span><span class="token punctuation">.</span><span class="token method function property-access">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre><p class="css-zitybv">当然，这只是一个简单的实现，实际上，调试器还需要支持更多的功能，包括查看当前执行的代码位置、变量值、标记断点等等，本文不再细述。</p><h2 id="覆盖率" class="css-1sg5i1s"><a href="#覆盖率" aria-label="覆盖率" class="css-1minv35"><svg viewBox="0 0 16 16" width="16" height="16" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>覆盖率</h2><p class="css-zitybv">另外，统计测试覆盖率也是一个非常重要的开发体验，是提高代码质量的主要手段。测试覆盖率主要考虑三个维度：</p><ul class="css-0"><li class="css-0">函数覆盖率：代码中的函数是否都被调用过？</li><li class="css-0">语句覆盖率：代码中的语句是否都被执行过？</li><li class="css-0">分支覆盖率：代码中的分支是否都被覆盖过？</li></ul><p class="css-zitybv">传统的测试覆盖率统计工具，通常是通过在代码中插入计数器，记录每个代码块被执行的次数，最后生成报告。它本质上是改变了实际执行的代码，例如被 Jest 等测试工具集成的 <a href="https://istanbul.js.org/" class="css-19seewt">istanbul</a> ，在执行时会将以下源代码：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">input </span><span class="token parameter operator">=</span><span class="token parameter"> </span><span class="token parameter number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">input</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> input </span><span class="token operator">?</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre><p class="css-zitybv">转换为：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">test</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  input </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">cov_159mw6va2c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">b</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain">  </span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">cov_159mw6va2c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">f</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">cov_159mw6va2c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">s</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">input</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">cov_159mw6va2c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">b</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">cov_159mw6va2c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">s</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">cov_159mw6va2c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">b</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">cov_159mw6va2c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">s</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> input</span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">?</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">cov_159mw6va2c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">b</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">cov_159mw6va2c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">b</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre><p class="css-zitybv">而由于我们的解释器是自己实现的，实现测试覆盖率的统计更为简单，只需要在遍历抽象语法树时，加入钩子即可：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token keyword">const</span><span class="token plain"> shouldCover </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> covered </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> ast </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token plain">source</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">walk</span><span class="token punctuation">(</span><span class="token plain">ast</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  hooks</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">beforeVisit</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      shouldCover</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">const</span><span class="token plain"> test </span><span class="token keyword">of</span><span class="token plain"> testCases</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> func </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token plain">ast</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    hooks</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">beforeEvaluate</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        covered</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  func</span><span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> test</span><span class="token punctuation">.</span><span class="token property-access">input</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> coverage </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token plain">shouldCover</span><span class="token punctuation">,</span><span class="token plain"> covered</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre><style data-emotion-css="kbbagd">.css-kbbagd{border:0;border-bottom:1px solid;border-color:var(--theme-ui-colors-muted,hsl(10,20%,94%));}</style><hr class="divider css-kbbagd"/><p class="css-zitybv">好了，现在我们已经掌握了基本的方法去实现一个 JavaScript 沙盒，并支持单步/断点调试，以及统计测试覆盖率，有兴趣的同学可以在线体验一下这个 <a href="https://codesandbox.io/p/sandbox/tiny-js-sandbox-app-f2dn8z?file=%2Fsrc%2Fcook.js" class="css-19seewt">Demo</a>，并试着改进其中的解释器。</p></section></article></main><style data-emotion-css="1i8tjli">.css-1i8tjli{margin-top:32px;padding-top:16px;}</style><footer class="css-1i8tjli"><hr class="css-kbbagd"/><style data-emotion-css="j6r63x">.css-j6r63x{margin-bottom:32px;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><style data-emotion-css="u5xevn">.css-u5xevn{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-bottom:32px;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-u5xevn"><style data-emotion-css="1emx3y6">.css-1emx3y6{margin-right:8px;margin-bottom:0;width:48px;min-width:48px;border-radius:99999px;}</style><div class="css-1emx3y6 gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:48px;height:48px"><img aria-hidden="true" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAC4jAAAuIwF4pT92AAAEj0lEQVQ4y02UWWxUVRjH777MTKdTKIEioASDZYsQVmMhIkQwJVaIsUrYiqVUoJ0ynXam0+ls3TvdKVtZLIhGYqMxKEYfIMYnQmJ8NtFHH4wPPvpifn73DqAPv5x779z7+/7nO+eM0pLsoUTmGeeekujhjPBhp0ea5o40TfFuGmNdnDyf5GQsScP5BCfaOjkW7eBISztKvCeLR/sTYv/jfLpEtDtLa0qKdfXQKtfxwoDPuVRWCiQ5JTS2J6RIJ0o6nyWdz9H9jDwpoSuXIykkhM6sSDJZOvMFKZRhX90hXttfy6m2GO25vMwi6dPcIcK+gRy9QkHI9+fIPaUvR1bI9OZI93qFsvSNDvNKzU4URfFxg2GONzeTLORoTSZ8lNFiD6PFDMWRLMVijuJogeGRPIPDOQaGcvQPecUyjEwMcvrsaRFpaLqBYdq+dPmK50kV0nRmksTTkvDKRJLLwuyFbsaH4/Tno0yNdTE1nmZiNI1XsCgFJyZ7Wb+u2pfoItQ0HVXVcF2X9mSUTH+KZLYD5c50jI+Fu7NdFBLH6e06wbWpdq7PJLg8GWdmIs6VmRR9+XNEQkFsVRWZhmEYvnz1S6sojqUp9MXJFWSVv5hu5rvrbeRbD1IRibB98zpmh5r4/KoUmolyc6qFuYttXBo7y4rFFZgiMQzdl0UiIdKpBiYnYgwOnPNRHlw4yk9zTfSe2u2/ZMhUNqyqInb8de5fO8Pd6UY+mfyAr2628n7dDjR5x9Fl2qpCIlrH7astTA2LdOQk40MNKD9Pv80v1+qZT+8jaKmEHdMXr3+hkgeXj3L/wmHmx9/j4UeN9LbsRZXfLN1m2ZJKbo0fYW7sMLPD9VwZqufi4Lsof17aw+8ze/nr5gEOv7rCl1maimNofJl7g0cXD/GjFL0/WsebNdVoVgQ3vBjFXEB97Wa+mXmHWwMHmOuv5UZfLco/t7fw9+w2uL2LfN1KSaAy37KR1Yscdq2p5I8btTwa2cvalVVSLCh7rwIrsAA7sBDDXUTy2FbuDe3hTmaXj8IP1XBvLXy7iV9H1/s9/G14K/NNpS0yc2QNBzY/L9cBfyMbThhLcAMRSRlh65plfN2zjc86NvFpfBPKW9tCHNwS4m50KY/7X8QxdRL7l8DcDjZUBVG0MlSrJNKccjRbrgXbDcvzcmqqq3jctZGHsXV837bWC+FtARVvXLnQpczSWBY2aNi+kKVhG92TyRQ1JyL9C6GZIVQRWiLUpcDLyytJ7X6O2M4qojVLUMpck/KgTURwbZuQJAyopbPqeOdVFsgTqUYAVQ+gyKKodrmf2O+nI89UCaUZJYKORci1KRPCQYeQpRMUYUj2misrHbBMdMMVoUilZ4otQkmmi9AOVBAMuPK9KVj+qARsA1ckAcsgaJsEJKGte9tG9++DtiV9K5dkC0RWURLKvddPy434vwf970sORZezaUgi0xt1DVNSeaOhl+69Y+b1T7FFaP0n9PpnitCUM23KOx6WdyQN769Il1Ry4E3de2jgWDa29NMxTUlvyxRF6FSUhE+kXhEvofe+J7JN+U74F/sJzXkeSJ6CAAAAAElFTkSuQmCC" alt="Shenwei Wang" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/2b467d8e9e1c0d3a8662ef8c8a223a18/aff39/avatar.png 1x,
/static/2b467d8e9e1c0d3a8662ef8c8a223a18/e5b88/avatar.png 1.5x,
/static/2b467d8e9e1c0d3a8662ef8c8a223a18/88b72/avatar.png 2x" /><img loading="lazy" width="48" height="48" srcset="/static/2b467d8e9e1c0d3a8662ef8c8a223a18/aff39/avatar.png 1x,
/static/2b467d8e9e1c0d3a8662ef8c8a223a18/e5b88/avatar.png 1.5x,
/static/2b467d8e9e1c0d3a8662ef8c8a223a18/88b72/avatar.png 2x" src="/static/2b467d8e9e1c0d3a8662ef8c8a223a18/aff39/avatar.png" alt="Shenwei Wang" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><div class="css-0">Personal Blog by <a class="css-19seewt" href="/">Shenwei Wang</a>.<br/>Writing code, raising kid, exploring the world.</div></div><style data-emotion-css="11r1i3o">.css-11r1i3o{-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;list-style:none;padding:0;}</style><style data-emotion-css="15qbtrw">.css-15qbtrw{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;list-style:none;padding:0;}</style><ul class="css-15qbtrw"><li><a rel="prev" class="css-19seewt" href="/multilingual-full-text-search/">← <!-- -->多语言全文搜索</a></li><li></li></ul></footer></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='UA-158375679-1',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
  if(!(parseInt(navigator.doNotTrack) === 1 || parseInt(window.doNotTrack) === 1 || parseInt(navigator.msDoNotTrack) === 1 || navigator.doNotTrack === "yes")) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-158375679-1', 'auto', {"siteSpeedSampleRate":33});
      ga('set', 'anonymizeIp', true);
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/implementing-a-javascript-sandbox/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-c92f2bc1a503c2693b02.js"],"app":["/app-bc0fa8565171cdc976ba.js"],"component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js":["/component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js-e132334849c54914e889.js"],"component---node-modules-gatsby-theme-blog-core-src-templates-posts-query-js":["/component---node-modules-gatsby-theme-blog-core-src-templates-posts-query-js-deca618258bfbf2a083d.js"],"component---src-pages-404-js":["/component---src-pages-404-js-923f2d364aee2c4033db.js"]};/*]]>*/</script><script src="/polyfill-c92f2bc1a503c2693b02.js" nomodule=""></script><script src="/component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js-e132334849c54914e889.js" async=""></script><script src="/commons-c09e6334871a95b3802a.js" async=""></script><script src="/app-bc0fa8565171cdc976ba.js" async=""></script><script src="/styles-2d4804b503525347efbe.js" async=""></script><script src="/framework-42897c4e770e3c8b7b7b.js" async=""></script><script src="/webpack-runtime-4d61d6f36b696a0865b2.js" async=""></script></body></html>