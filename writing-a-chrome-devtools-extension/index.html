<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.75f38c4997591d90ecdc.css">:root{--reach-skip-nav:1}[data-reach-skip-nav-link]{border:0;clip:rect(0 0 0 0);height:1px;width:1px;margin:-1px;padding:0;overflow:hidden;position:absolute}[data-reach-skip-nav-link]:focus{padding:1rem;position:fixed;top:10px;left:10px;background:#fff;z-index:1;width:auto;height:auto;clip:auto}p.figure-caption{text-align:center;opacity:.6;font-size:87.5%;margin-top:-14px;font-style:italic;width:-webkit-fit-content;width:-moz-fit-content;width:fit-content;max-width:90%;margin-left:auto;margin-right:auto;border-bottom:1px solid #ccc;padding-left:28px;padding-right:28px;padding-bottom:7px}hr.divider{border:none;font-size:150%;letter-spacing:.6em;margin-bottom:42px;text-align:center}hr.divider:before{content:"..."}footer>hr{margin-bottom:16px}a[role=button]{cursor:pointer}.highlight{border-left:3px solid #cc4c33;padding-left:13px;padding-right:16px;margin-left:-16px;margin-right:-16px}[data-reach-skip-nav-link]{display:none}.search-mark{box-shadow:0 1px 0 0 currentColor}.slide-ignore-end,.slide-ignore-start,.slide-only,.slide-page-end,.slide-page-start,.slide-title{display:none}.slide-canvas{display:flex;justify-content:center;align-items:center;height:calc(100vh - 64px)}.slide-canvas>section :first-child{margin-top:0}.slide-canvas>section :last-child{margin-bottom:0}.slide-canvas .slide-only{display:block}.slide-title-page{font-family:Montserrat,sans-serif;font-size:32px;text-align:center}.slide-canvas .prism-code{margin-left:0;margin-right:0;border-radius:10px}body.headless :not(article)>header,body.headless main+footer{display:none}@media screen and (min-width:40em){h1>a{font-size:32px}.prism-code{border-radius:10px}}.slide-bounce-left{animation:bounce-left .2s ease 0ms 4 alternate}.slide-bounce-right{animation:bounce-right .2s ease 0ms 4 alternate}@keyframes bounce-left{0%{transform:translateX(0)}to{transform:translateX(32px)}}@keyframes bounce-right{0%{transform:translateX(0)}to{transform:translateX(-32px)}}</style><meta name="generator" content="Gatsby 2.24.10"/><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><title data-react-helmet="true">编写一个 Chrome 开发者工具的扩展程序 | WeAreOutMan</title><link data-react-helmet="true" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&amp;family=Montserrat:wght@700;900&amp;display=swap"/><meta data-react-helmet="true" property="og:image" content="https://www.wangshenwei.com/static/2b467d8e9e1c0d3a8662ef8c8a223a18/88b72/avatar.png"/><meta data-react-helmet="true" name="description" content="在工作中的一个项目里，我们的前端框架建立在  Web Components  技术之上，每个界面都由数个到数十个  Custom Elements  组成。它们基于 Web 标准技术，因此开发者可以直接使用浏览器原生的开发者工具来辅助开发和调试。例如利用 Chrome…"/><meta data-react-helmet="true" property="og:title" content="编写一个 Chrome 开发者工具的扩展程序"/><meta data-react-helmet="true" property="og:description" content="在工作中的一个项目里，我们的前端框架建立在  Web Components  技术之上，每个界面都由数个到数十个  Custom Elements  组成。它们基于 Web 标准技术，因此开发者可以直接使用浏览器原生的开发者工具来辅助开发和调试。例如利用 Chrome…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:creator" content="Shenwei Wang"/><meta data-react-helmet="true" name="twitter:title" content="编写一个 Chrome 开发者工具的扩展程序"/><meta data-react-helmet="true" name="twitter:description" content="在工作中的一个项目里，我们的前端框架建立在  Web Components  技术之上，每个界面都由数个到数十个  Custom Elements  组成。它们基于 Web 标准技术，因此开发者可以直接使用浏览器原生的开发者工具来辅助开发和调试。例如利用 Chrome…"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><link rel="icon" href="/favicon-32x32.png?v=2b467d8e9e1c0d3a8662ef8c8a223a18"/><link rel="manifest" href="/manifest.webmanifest"/><link as="script" rel="preload" href="/webpack-runtime-4d61d6f36b696a0865b2.js"/><link as="script" rel="preload" href="/framework-42897c4e770e3c8b7b7b.js"/><link as="script" rel="preload" href="/styles-2d4804b503525347efbe.js"/><link as="script" rel="preload" href="/app-bc0fa8565171cdc976ba.js"/><link as="script" rel="preload" href="/commons-c09e6334871a95b3802a.js"/><link as="script" rel="preload" href="/component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js-e132334849c54914e889.js"/><link as="fetch" rel="preload" href="/page-data/writing-a-chrome-devtools-extension/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/static/d/2744905544.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/static/d/3090755652.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/static/d/386998304.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/static/d/764694655.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>(function() { try {
  var mode = localStorage.getItem('theme-ui-color-mode');
  if (!mode) return
  document.body.classList.add('theme-ui-' + mode);
} catch (e) {} })();</script><div id="___gatsby"><style data-emotion-css="wnkb0j">body{--theme-ui-colors-text:var(--theme-ui-colors-text,hsl(10,20%,20%));--theme-ui-colors-background:var(--theme-ui-colors-background,hsl(10,10%,98%));--theme-ui-colors-primary:var(--theme-ui-colors-primary,hsl(10,80%,50%));--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,hsl(10,60%,50%));--theme-ui-colors-highlight:var(--theme-ui-colors-highlight,hsl(10,40%,90%));--theme-ui-colors-purple:var(--theme-ui-colors-purple,hsl(250,60%,30%));--theme-ui-colors-muted:var(--theme-ui-colors-muted,hsl(10,20%,94%));--theme-ui-colors-gray:var(--theme-ui-colors-gray,hsl(10,20%,50%));--theme-ui-colors-inline-code:var(--theme-ui-colors-inline-code,hsl(10,60%,50%));color:var(--theme-ui-colors-text,hsl(10,20%,20%));background-color:var(--theme-ui-colors-background,hsl(10,10%,98%));}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,hsl(210,50%,96%));--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,hsl(230,25%,18%));--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,hsla(230,20%,0%,20%));--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,rgb(242,95,92));--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,hsl(10,80%,50%));--theme-ui-colors-inline-code:var(--theme-ui-colors-modes-dark-inline-code,hsl(290,100%,80%));}</style><style data-emotion-css="jr3v97">*{box-sizing:border-box;}body{margin:0;font-family:'Merriweather','Georgia',serif;line-height:1.75;font-weight:400;font-size:16px;}</style><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="628fci">.css-628fci{font-family:'Merriweather','Georgia',serif;line-height:1.75;font-weight:400;font-size:16px;}</style><div class="css-628fci"><header><style data-emotion-css="19seewt">.css-19seewt{color:var(--theme-ui-colors-primary,hsl(10,80%,50%));-webkit-text-decoration:none;text-decoration:none;box-shadow:0 1px 0 0 currentColor;}.css-19seewt:hover{color:var(--theme-ui-colors-secondary,hsl(10,60%,50%));}</style><a class="css-19seewt" href="#reach-skip-nav" data-reach-skip-link="" data-reach-skip-nav-link="">Skip to content</a><style data-emotion-css="ckq4zy">.css-ckq4zy{max-width:704px;margin-left:auto;margin-right:auto;padding-left:16px;padding-right:16px;padding-top:32px;}</style><div class="css-ckq4zy"><style data-emotion-css="pcqfzb">.css-pcqfzb{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin-bottom:8px;}</style><div class="css-pcqfzb"><style data-emotion-css="1qd1r5f">.css-1qd1r5f{margin-top:0;margin-bottom:0;}</style><style data-emotion-css="dkbyqt">.css-dkbyqt{font-family:Montserrat,sans-serif;font-weight:700;line-height:1.25;font-size:20px;margin-top:0;margin-bottom:0;}@media screen and (min-width:40em){.css-dkbyqt{font-size:24px;}}</style><p class="css-dkbyqt"><style data-emotion-css="15vs81m">.css-15vs81m{box-shadow:none;-webkit-text-decoration:none;text-decoration:none;color:var(--theme-ui-colors-primary,hsl(10,80%,50%));}</style><style data-emotion-css="14rk83l">.css-14rk83l{color:var(--theme-ui-colors-primary,hsl(10,80%,50%));-webkit-text-decoration:none;text-decoration:none;box-shadow:0 1px 0 0 currentColor;box-shadow:none;-webkit-text-decoration:none;text-decoration:none;color:var(--theme-ui-colors-primary,hsl(10,80%,50%));}.css-14rk83l:hover{color:var(--theme-ui-colors-secondary,hsl(10,60%,50%));}</style><a class="css-14rk83l" href="/">WeAreOutMan</a></p><style data-emotion-css="135vz7z">.css-135vz7z{box-shadow:none;-webkit-text-decoration:none;text-decoration:none;}</style><style data-emotion-css="o63vl5">.css-o63vl5{color:var(--theme-ui-colors-primary,hsl(10,80%,50%));-webkit-text-decoration:none;text-decoration:none;box-shadow:0 1px 0 0 currentColor;box-shadow:none;-webkit-text-decoration:none;text-decoration:none;}.css-o63vl5:hover{color:var(--theme-ui-colors-secondary,hsl(10,60%,50%));}</style><a role="button" class="css-o63vl5">Dark</a></div></div></header><div id="reach-skip-nav" data-reach-skip-nav-content=""></div><div><style data-emotion-css="b93ooj">.css-b93ooj{max-width:704px;margin-left:auto;margin-right:auto;padding-left:16px;padding-right:16px;padding-top:32px;padding-bottom:32px;}</style><div class="css-b93ooj"><main><article><header><style data-emotion-css="17d3iyk">.css-17d3iyk{font-family:Montserrat,sans-serif;font-weight:900;line-height:1.25;font-size:32px;-webkit-letter-spacing:-0.03em;-moz-letter-spacing:-0.03em;-ms-letter-spacing:-0.03em;letter-spacing:-0.03em;margin-top:16px;}@media screen and (min-width:40em){.css-17d3iyk{font-size:40px;}}</style><h1 class="css-17d3iyk">编写一个 Chrome 开发者工具的扩展程序</h1><style data-emotion-css="1h1xv8c">.css-1h1xv8c{font-size:14px;margin-top:-16px;margin-bottom:16px;}</style><style data-emotion-css="1w2ean9">.css-1w2ean9{margin-top:32px;margin-bottom:32px;font-size:14px;margin-top:-16px;margin-bottom:16px;}</style><p class="css-1w2ean9">April 25, 2020</p></header><section><style data-emotion-css="zitybv">.css-zitybv{margin-top:32px;margin-bottom:32px;}</style><p class="css-zitybv">在工作中的一个项目里，我们的前端框架建立在 <a href="https://developer.mozilla.org/en-US/docs/Web/Web_Components" class="css-19seewt">Web Components</a> 技术之上，每个界面都由数个到数十个 <a href="https://developer.mozilla.org/en-US/docs/Web/Web_Components/Using_custom_elements" class="css-19seewt">Custom Elements</a> 组成。它们基于 Web 标准技术，因此开发者可以直接使用浏览器原生的开发者工具来辅助开发和调试。例如利用 Chrome 的开发者工具，我们可以直接审查指定的 Custom Elements，也可以在控制台中打印出它们的属性等等。</p><p class="css-zitybv">这些自定义元素通常都有与业务相关的自定义属性、方法和事件，虽然我们可以在控制台中打印出这个元素，但是要从大量的继承自 <style data-emotion-css="m301d5">.css-m301d5{font-family:Menlo,monospace;color:var(--theme-ui-colors-inline-code,hsl(10,60%,50%));background-color:var(--theme-ui-colors-muted,hsl(10,20%,94%));padding-left:3px;padding-right:3px;}</style><code class="css-m301d5">HTMLElement</code> 的属性中分辨出想要的业务属性并不容易。另一方面，框架为静态声明式的配置文件添加了运行时处理动态数据的能力，开发者有时希望能审查这些数据转换的过程。</p><p class="css-zitybv">浏览器原生的开发者工具已经不能满足需求，因此我们决定扩展一下它的能力。</p><p class="css-zitybv">在讲述如何编写这个扩展程序前，先看两张成品图片，以便理解我们想要拓展的能力。我们为开发者工具新建了一个 <em class="css-0">“Bricks”</em> 面板，它可以列出当前审查的页面由自定义元素组成的渲染树，鼠标经过时可以实时显示对应元素的轮廓，点击选中一个元素则可以显示它的业务属性和事件配置等。</p><p class="css-zitybv"><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1380px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:88.9855072463768%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAASABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIFAf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAFeQs12Ml5QSD//xAAbEAACAQUAAAAAAAAAAAAAAAAAAhQBBBIgIf/aAAgBAQABBQJbzFZ1Sec2/8QAFREBAQAAAAAAAAAAAAAAAAAAASD/2gAIAQMBAT8BI//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABoQAAICAwAAAAAAAAAAAAAAAAABEjIgMaH/2gAIAQEABj8CSiVKdNZf/8QAHRAAAgEEAwAAAAAAAAAAAAAAAAExEBEh0UFRYf/aAAgBAQABPyFvE/TFuLteG7NhRiqgcn//2gAMAwEAAgADAAAAEIsHfP/EABkRAAIDAQAAAAAAAAAAAAAAAAABEBExQf/aAAgBAwEBPxBOFC2P/8QAGBEAAgMAAAAAAAAAAAAAAAAAAREAECH/2gAIAQIBAT8QJeuO/wD/xAAeEAACAgICAwAAAAAAAAAAAAABEQAhMVEQQWHB0f/aAAgBAQABPxAJDQkPv3qCwa+A+RIsLdPUQB1KE0QeHEdDiwuZ5//Z&#x27;);background-size:cover;display:block"></span>
  <style data-emotion-css="9whsf3">.css-9whsf3{max-width:100%;}</style><img class="gatsby-resp-image-image css-9whsf3" alt="Bricks Panel" title="Bricks Panel" src="/static/c7d0866de9154704bc5b26f39014ec6b/89b2d/screen-shot-bricks-panel.jpg" srcSet="/static/c7d0866de9154704bc5b26f39014ec6b/8d48c/screen-shot-bricks-panel.jpg 345w,/static/c7d0866de9154704bc5b26f39014ec6b/15ec7/screen-shot-bricks-panel.jpg 690w,/static/c7d0866de9154704bc5b26f39014ec6b/89b2d/screen-shot-bricks-panel.jpg 1380w" sizes="(max-width: 1380px) 100vw, 1380px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p class="css-zitybv">切换到 <em class="css-0">“Evaluations”</em> 则可以实时显示框架中被称为 <em class="css-0">“Evaluate”</em> 的数据处理的过程、结果及其上下文信息。</p><p class="css-zitybv"><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1380px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:30.434782608695656%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAGABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAByoAH/8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQABBQJ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFxABAQEBAAAAAAAAAAAAAAAAAQARUf/aAAgBAQABPyFTrFt//9oADAMBAAIAAwAAABCDz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAQACAwEAAAAAAAAAAAAAAAEAESFBYYH/2gAIAQEAAT8Qwnwjpq0OMsbZ/9k=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image css-9whsf3" alt="Evaluations Panel" title="Evaluations Panel" src="/static/dc3460c64981cf7af7a60aecd25ed1c3/89b2d/screen-shot-evaluations-panel.jpg" srcSet="/static/dc3460c64981cf7af7a60aecd25ed1c3/8d48c/screen-shot-evaluations-panel.jpg 345w,/static/dc3460c64981cf7af7a60aecd25ed1c3/15ec7/screen-shot-evaluations-panel.jpg 690w,/static/dc3460c64981cf7af7a60aecd25ed1c3/89b2d/screen-shot-evaluations-panel.jpg 1380w" sizes="(max-width: 1380px) 100vw, 1380px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><style data-emotion-css="kbbagd">.css-kbbagd{border:0;border-bottom:1px solid;border-color:var(--theme-ui-colors-muted,hsl(10,20%,94%));}</style><hr class="divider css-kbbagd"/><style data-emotion-css="1vwrubw">.css-1vwrubw{padding-left:32px;padding-right:32px;margin-left:0;margin-right:0;border-left:5px solid #ccc;opacity:0.8;}.css-1vwrubw footer{opacity:0.6;}</style><blockquote class="css-1vwrubw"><p class="css-zitybv">本文不会从头讲述如何一步一步地编写扩展程序，对于这些我们应该去阅读<a href="https://developer.chrome.com/extensions" class="css-19seewt">官方开发手册</a>。本文主要侧重讲述其中不易理解、或相对困难的部分，如扩展程序中各模块的通讯方式、限制、以及如何突破这些限制等。</p></blockquote><p class="css-zitybv">接下来进入正题，首先阅读官方的几篇文档《<a href="https://developer.chrome.com/extensions/getstarted" class="css-19seewt">Getting Started Tutorial</a>》、《<a href="https://developer.chrome.com/extensions/devtools" class="css-19seewt">Extending DevTools</a>》，其中下面这张图很好地解释了一个 Chrome 开发者工具扩展程序所涉及的几个主要模块及其之间的关系：</p><p class="css-zitybv"><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:522px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:106.37681159420289%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsSAAALEgHS3X78AAAEGklEQVQ4y32T+1MaVxTH+bf6k81LhfDSKGqnk2TamfYP6E8d22k7bScTEzLamBaDiw9AAaNi1ICPKCKw7MpL0OUhuMCyL0QXVh5CRXoRbX9op2e+c+fs3fO559x77hXUarV0Op1KpVpjMpnMZDLMrYG/jUYjiDNwlESPGPSIBuNeIutLnZUqVUE2mzWZTDPAZg2muXdT09qVDxY3gsIwbLfbGYauXzWejtk/fbHTOewUvkbbX+0If/cqDEQ4xTRhEOfxeIJe9MDXVMiLhDzugHfP6XTRFAXgr7QBoTos04SlmnCPkVIscgpjBkvSTdjlcoFUQ0bb9zrbj7O7P8zsfKfbMaw53S4HzTAUzT5W7d4fcYtGUdHonlQdUpjzCsMtDF/TfeO+tjfBdnXkgergzptQ73jAvG6niLTPH/hSGxBPHXdPx+VT8S7tsVyLg7KxJHMDw27kCYSKVPtSlVcy5u+ZTUug8IzVRaVxJpv7egpte7YuGnG0D212KLfEY/sDc9TtngGMoH0jG22/Wh6Oog9VPrE6KIMwzeJGPIoRJP34reOTZ7Y7Ssdd5e791x6RlhBD0UOc+ifzF3pMpif65k/6lwqK+VO5BhtSG4J+T7FUWnWFJqzo7Jb/57cmaMWp3/TpN9AcV2idtssJu5/MpRTvSwNmrh9o4VQOYcZ1+DRLgz5fXRtwGDJTq1Ybt9aEEQQJ+H2DJs+9sbAQinRC0c7xaIcqqLc4ThgSBF1e1oGAQ1H0RbUGlgH9A8sJWJa1Wq1bHzfXrB+ea1dfGj++mNl4rl8fmt00mVcYmiqVSiRJstdG03SrhJvMlUrF7UYcDie4Kn7UZdJNOm2bQQ8SQF0IDJfLFZbNgph6HSS/rNebbEtN+O9lWhPnhXylWOByLIhtTTMU2Gel8V8mqNb+3IuR7giBxEgkRvnwnD+dN2y4XVHai5/tk/z8bmjZl3LivD1+tnPEwXjem+aaD+OiKsgwJ6Lf4HvD7gcj7rsv7eCcuuc5xWK+y5SVGxmJgX26QL3aJoCU28SwLf3NUqJDz3bpU80+E8xJz2RYOpWQT8elUBhINhEVqw96508GlvLyOW7QQlyVCxfnXJk/bdRK4OkOrh536QkMwBkm90hzKIEisomITBORTcakECbVRLp0+CN9UmpgB9fIcql4jONYOJzn+XyOjadIhTZ+gNPNsruhoEQTAYxME5VPxsDVBb5EfQAuuURPfmvJlHmOPy9yeb7AFymSBDn7dC2YzX1uzvUvlz5bLg4AvT8Hzo1WwCff+y477UjwbJrLkkA8SxBMtn8GPwQwQWfFENahSQg18c5/STgRb5/A28djPy0GlZbw0CqmtGC/LGPCPwKhREZQKpeXd/0L23uLNs//SLeOateQloBvtnnP8oW/AI52u5Z8jy4sAAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image css-9whsf3" alt="DevTools Extension" title="DevTools Extension" src="/static/b1967acb93d62f5ecdd8c3d179095d71/29492/devtools-extension.png" srcSet="/static/b1967acb93d62f5ecdd8c3d179095d71/e4d6b/devtools-extension.png 345w,/static/b1967acb93d62f5ecdd8c3d179095d71/29492/devtools-extension.png 522w" sizes="(max-width: 522px) 100vw, 522px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p class="css-zitybv">Content scripts:</p><ul class="css-0"><li class="css-0">以当前审查的页面为上下文访问完整的 DOM 接口；</li><li class="css-0">在相对的孤立世界中执行，它的执行被设计为不与页面或其它 content scripts 冲突；</li><li class="css-0">可以与 Background page 通信；</li></ul><p class="css-zitybv">Background page:</p><ul class="css-0"><li class="css-0">可以访问完整的扩展程序 API；</li><li class="css-0">可以分别与 Content scripts、 DevTools page 通信；</li></ul><p class="css-zitybv">DevTools page:</p><ul class="css-0"><li class="css-0">可以访问 <code class="css-m301d5">chrome.devtools.*</code> API；</li><li class="css-0">为开发者工具创建新的面板；</li></ul><p class="css-zitybv">其中 <code class="css-m301d5">chrome.devtools.inspectedWindow.eval</code>:</p><ul class="css-0"><li class="css-0">可以在 DevTools page 及其创建的面板页面中使用它；</li><li class="css-0">以当前审查的页面为上下文执行指定 JavaScript 代码；</li><li class="css-0">该上下文还额外包括了开发者工具控制台 API；</li><li class="css-0">可以设置一个选项以使用 content scripts 上下文来执行代码。</li></ul><p class="css-zitybv">我们的扩展程序的主要业务逻辑和界面都在 DevTools page，它不能直接访问 DOM，而我们需要展示的信息几乎都来自 DOM，因此只能借助其它模块来实现间接访问。</p><p class="css-zitybv">首先看最接近 DOM 的 content scripts，它有个关键词—<em class="css-0">“孤立世界”</em>，虽然官方文档对此有<a href="https://developer.chrome.com/extensions/content_scripts#isolated_world" class="css-19seewt">说明</a>，但依然有些令人费解。从手工测试结果来看，content scripts 中访问标准的 DOM 接口可以按预期工作，除此之外的操作将撞上孤立世界的边界，即：除了标准 DOM 接口以外的操作只能影响该脚本自身。</p><p class="css-zitybv">例如以下 content script 可以按预期工作：</p><style data-emotion-css="1v64iiv">.css-1v64iiv{font-family:Menlo,monospace;font-size:14px;padding:16px;color:#9CDCFE;background-color:#1E1E1E;overflow:auto;margin-bottom:32px;margin-left:-16px;margin-right:-16px;}.css-1v64iiv .comment,.css-1v64iiv .prolog,.css-1v64iiv .doctype,.css-1v64iiv .cdata,.css-1v64iiv .punctuation,.css-1v64iiv .operator,.css-1v64iiv .entity,.css-1v64iiv .url{color:var(--theme-ui-colors-gray,hsl(10,20%,50%));}.css-1v64iiv .comment{color:rgb(106,153,85);}.css-1v64iiv .property,.css-1v64iiv .tag,.css-1v64iiv .boolean,.css-1v64iiv .number,.css-1v64iiv .constant,.css-1v64iiv .symbol,.css-1v64iiv .deleted,.css-1v64iiv .function,.css-1v64iiv .class-name,.css-1v64iiv .regex,.css-1v64iiv .important,.css-1v64iiv .variable{color:var(--theme-ui-colors-purple,hsl(250,60%,30%));}.css-1v64iiv .atrule,.css-1v64iiv .attr-value,.css-1v64iiv .keyword{color:var(--theme-ui-colors-primary,hsl(10,80%,50%));}.css-1v64iiv .selector,.css-1v64iiv .attr-name,.css-1v64iiv .string,.css-1v64iiv .char,.css-1v64iiv .builtin,.css-1v64iiv .inserted{color:var(--theme-ui-colors-secondary,hsl(10,60%,50%));}.css-1v64iiv .property,.css-1v64iiv .title,.css-1v64iiv .important,.css-1v64iiv .boolean,.css-1v64iiv .regex{color:inherit;}.css-1v64iiv .regex{color:var(--theme-ui-colors-secondary,hsl(10,60%,50%));}.css-1v64iiv code{color:inherit;}.css-1v64iiv .prolog{color:rgb(0,0,128);}.css-1v64iiv .builtin,.css-1v64iiv .changed,.css-1v64iiv .keyword{color:rgb(86,156,214);}.css-1v64iiv .number,.css-1v64iiv .inserted{color:rgb(181,206,168);}.css-1v64iiv .constant{color:rgb(100,102,149);}.css-1v64iiv .attr-name,.css-1v64iiv .variable{color:rgb(156,220,254);}.css-1v64iiv .deleted,.css-1v64iiv .string,.css-1v64iiv .attr-value{color:rgb(206,145,120);}.css-1v64iiv .selector{color:rgb(215,186,125);}.css-1v64iiv .tag{color:rgb(86,156,214);}.css-1v64iiv .punctuation,.css-1v64iiv .operator{color:rgb(212,212,212);}.css-1v64iiv .punctuation{color:#808080;}.css-1v64iiv .function{color:rgb(220,220,170);}.css-1v64iiv .class-name{color:rgb(78,201,176);}.css-1v64iiv .char{color:rgb(209,105,105);}.css-1v64iiv .highlight{background:hsla(0,0%,40%,.5);}</style><style data-emotion-css="a7hg0h">.css-a7hg0h{font-family:Menlo,monospace;color:#9cdcfe;font-size:14px;}</style><style data-emotion-css="194ank4">.css-194ank4{font-family:Menlo,monospace;font-size:14px;padding:16px;color:#9CDCFE;background-color:#1E1E1E;overflow:auto;margin-bottom:32px;margin-left:-16px;margin-right:-16px;font-family:Menlo,monospace;color:#9cdcfe;font-size:14px;}.css-194ank4 .comment,.css-194ank4 .prolog,.css-194ank4 .doctype,.css-194ank4 .cdata,.css-194ank4 .punctuation,.css-194ank4 .operator,.css-194ank4 .entity,.css-194ank4 .url{color:var(--theme-ui-colors-gray,hsl(10,20%,50%));}.css-194ank4 .comment{color:rgb(106,153,85);}.css-194ank4 .property,.css-194ank4 .tag,.css-194ank4 .boolean,.css-194ank4 .number,.css-194ank4 .constant,.css-194ank4 .symbol,.css-194ank4 .deleted,.css-194ank4 .function,.css-194ank4 .class-name,.css-194ank4 .regex,.css-194ank4 .important,.css-194ank4 .variable{color:var(--theme-ui-colors-purple,hsl(250,60%,30%));}.css-194ank4 .atrule,.css-194ank4 .attr-value,.css-194ank4 .keyword{color:var(--theme-ui-colors-primary,hsl(10,80%,50%));}.css-194ank4 .selector,.css-194ank4 .attr-name,.css-194ank4 .string,.css-194ank4 .char,.css-194ank4 .builtin,.css-194ank4 .inserted{color:var(--theme-ui-colors-secondary,hsl(10,60%,50%));}.css-194ank4 .property,.css-194ank4 .title,.css-194ank4 .important,.css-194ank4 .boolean,.css-194ank4 .regex{color:inherit;}.css-194ank4 .regex{color:var(--theme-ui-colors-secondary,hsl(10,60%,50%));}.css-194ank4 code{color:inherit;}.css-194ank4 .prolog{color:rgb(0,0,128);}.css-194ank4 .builtin,.css-194ank4 .changed,.css-194ank4 .keyword{color:rgb(86,156,214);}.css-194ank4 .number,.css-194ank4 .inserted{color:rgb(181,206,168);}.css-194ank4 .constant{color:rgb(100,102,149);}.css-194ank4 .attr-name,.css-194ank4 .variable{color:rgb(156,220,254);}.css-194ank4 .deleted,.css-194ank4 .string,.css-194ank4 .attr-value{color:rgb(206,145,120);}.css-194ank4 .selector{color:rgb(215,186,125);}.css-194ank4 .tag{color:rgb(86,156,214);}.css-194ank4 .punctuation,.css-194ank4 .operator{color:rgb(212,212,212);}.css-194ank4 .punctuation{color:#808080;}.css-194ank4 .function{color:rgb(220,220,170);}.css-194ank4 .class-name{color:rgb(78,201,176);}.css-194ank4 .char{color:rgb(209,105,105);}.css-194ank4 .highlight{background:hsla(0,0%,40%,.5);}</style><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token comment">/* @file: your-content-script.js */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">body</span><span class="token punctuation">.</span><span class="token property-access">style</span><span class="token punctuation">.</span><span class="token property-access">background</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&quot;red&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre><p class="css-zitybv">而以下脚本无法按预期工作：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token comment">/* @file: your-content-script.js */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 假设审查的页面给 `body` 添加了自定义属性 `yourAddon`，</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 但由于它不是标准 DOM 接口，content scripts 无法访问它，</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 因此这里只会打印 `undefined`。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">body</span><span class="token punctuation">.</span><span class="token property-access">yourAddon</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><style data-emotion-css="1baulvz">.css-1baulvz{display:inline-block;}</style><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 同样适用于全局变量。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token constant">YOUR_METADATA</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 为元素赋值 `yourAddon` 将只影响该脚本自身。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">body</span><span class="token punctuation">.</span><span class="token property-access">yourAddon</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 将打印 `&quot;hello world&quot;`。但在审查的页面中，该属性不受影响。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">body</span><span class="token punctuation">.</span><span class="token property-access">yourAddon</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre><p class="css-zitybv">我们想要展示的、由自定义元素组成的渲染树及其业务属性等信息，正是标准 DOM 接口以外的数据，content scripts 无法直接访问，需要另辟蹊径。</p><p class="css-zitybv">再看 <code class="css-m301d5">inspectedWindow.eval</code>，它也能以当前审查的页面为上下文执行代码，它接收一段字符串作为代码执行，并且将执行结果传递给回调函数，例如：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token comment">/* @file: your-devtools-page.js */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">chrome</span><span class="token punctuation">.</span><span class="token property-access">devtools</span><span class="token punctuation">.</span><span class="token property-access">inspectedWindow</span><span class="token punctuation">.</span><span class="token method function property-access">eval</span><span class="token punctuation">(</span><span class="token string">&quot;document.body.yourAddon&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 假设审查的页面给 `body` 添加了自定义属性 `yourAddon` 值为 `&quot;hello world&quot;`，</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 将打印 `&quot;hello world&quot;`。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">result</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre><p class="css-zitybv">这看起来可以让我们拿到想要的渲染树信息了。但是官方文档也说明了它对代码执行结果的要求：<em class="css-0">合法的 JSON 对象</em>，即可以序列化为 JSON 的对象，它只能包含 JavaScript 原始类型的值、并且不包含循环引用。这意味着它的能力受到了限制，例如无法直接传递原生事件对象 <code class="css-m301d5">Event</code>、<code class="css-m301d5">CustomEvent</code> 或者内部包含循环引用的属性，不过我们先暂时放下这个问题。</p><p class="css-zitybv">渲染树信息可以由框架封装接口提供给 <code class="css-m301d5">inspectedWindow.eval</code> 调用，但这意味着框架需要额外捆绑扩展程序专用的代码逻辑，并且这些逻辑与扩展程序紧密相关，这增加了代码耦合度。</p><p class="css-zitybv">为了尽量减少对框架的侵入、降低耦合，还需要进一步探索。在参考了 <a href="https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi" class="css-19seewt">React Developer Tools</a> 的源码后，我发现了能让代码在真正的审查页面的上下文中执行的方法。在 content scripts 中动态插入 <code class="css-m301d5">&lt;script&gt;</code> 标签，插入 <code class="css-m301d5">&lt;script&gt;</code> 的过程是标准的 DOM 操作，仍然在 content scripts 的孤立世界中，而它指向的代码文件则跳脱了出来！</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token comment">/* @file: your-content-script.js */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> script </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// `hook.js` 将在真正的审查页面的上下文中执行。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">script</span><span class="token punctuation">.</span><span class="token property-access">src</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> chrome</span><span class="token punctuation">.</span><span class="token property-access">runtime</span><span class="token punctuation">.</span><span class="token method function property-access">getURL</span><span class="token punctuation">(</span><span class="token string">&quot;hook.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">documentElement</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token plain">script</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">script</span><span class="token punctuation">.</span><span class="token property-access">parentNode</span><span class="token punctuation">.</span><span class="token method function property-access">removeChild</span><span class="token punctuation">(</span><span class="token plain">script</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre><p class="css-zitybv">由此，获取渲染树信息的代码逻辑可以放在 <code class="css-m301d5">hook.js</code> 中，并在 DevTools page 中使用 Eval 接口调用它。</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token comment">/* @file: hook.js */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">getRenderTree</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token spread operator">...</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">/* @file: your-devtools-page.js */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">chrome</span><span class="token punctuation">.</span><span class="token property-access">devtools</span><span class="token punctuation">.</span><span class="token property-access">inspectedWindow</span><span class="token punctuation">.</span><span class="token method function property-access">eval</span><span class="token punctuation">(</span><span class="token string">&quot;window.getRenderTree()&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Display render tree.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre><p class="css-zitybv">渲染树可以显示了，那么如何获取单个自定义元素呢？Eval 接口接收的是一串字符串代码，无法为它传递引用，但我们可以想办法在 <code class="css-m301d5">hook.js</code> 中存储一个映射表来存放自增 ID 与自定义元素的关系，Eval 调用时只传递 ID。</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token comment">/* @file: hook.js */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 简易自增 ID 工厂</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> uniqueIdCounter </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">uniqueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">uniqueIdCounter </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 映射表</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> uidToElement </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">getRenderTree</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 记录映射表</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  uidToElement</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token function">uniqueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> element</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 获取元素属性信息</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">getElement</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">uid</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> uidToElement</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token plain">uid</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">/* @file: your-devtools-page.js */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">chrome</span><span class="token punctuation">.</span><span class="token property-access">devtools</span><span class="token punctuation">.</span><span class="token property-access">inspectedWindow</span><span class="token punctuation">.</span><span class="token method function property-access">eval</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">window.getElement(</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">uid</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">).props</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// Display element props.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre><p class="css-zitybv">之前提到过 Eval 接口还可以访问<a href="https://developers.google.com/web/tools/chrome-devtools/console/utilities" class="css-19seewt">开发者工具控制台 API</a>，例如我们可以调用 <code class="css-m301d5">inspect()</code> 来审查元素或函数：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token comment">/* @file: your-devtools-page.js */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// `inspect(element)` 将打开 Element 面板并选中该元素。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">chrome</span><span class="token punctuation">.</span><span class="token property-access">devtools</span><span class="token punctuation">.</span><span class="token property-access">inspectedWindow</span><span class="token punctuation">.</span><span class="token method function property-access">eval</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">inspect(window.getElement(</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">uid</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">));</span><span class="token template-string template-punctuation string">`</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// `inspect(function)` 将打开 Source 面板并指向该函数对应的源码。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">chrome</span><span class="token punctuation">.</span><span class="token property-access">devtools</span><span class="token punctuation">.</span><span class="token property-access">inspectedWindow</span><span class="token punctuation">.</span><span class="token method function property-access">eval</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">inspect(window.getElement(</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">uid</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">).constructor);</span><span class="token template-string template-punctuation string">`</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre><p class="css-zitybv">迄今为止我们都是在 DevTools page 主动调用 Eval 接口获取信息，但有时候我们需要响应来自审查的页面的消息，例如当页面重新渲染后，希望 DevTools page 能够自动重新获取渲染树，又或者框架完成一次 Evaluate 数据处理后，希望在 DevTools page 实时显示。</p><p class="css-zitybv">上文介绍过，DevTools page 无法直接和审查的页面通信，但我们可以通过 content script 和 background page 作为代理管道转发消息完成通信。</p><pre class="prism-code language-css-a7hg0h css-194ank4"><div class="token-line"><span class="token plain">Hook</span></div><div class="token-line"><span class="token plain">    ↖↘</span></div><div class="token-line"><span class="token plain">  Content script</span></div><div class="token-line"><span class="token plain">        ↖↘</span></div><div class="token-line"><span class="token plain">      Background page</span></div><div class="token-line"><span class="token plain">            ↖↘</span></div><div class="token-line"><span class="token plain">          DevTools page</span></div></pre><p class="css-zitybv">其中需要注意的是，对于每个扩展程序，只有一个 background page 实例，而 content script 和 DevTools page 则是每个 tab 页对应一个实例，因此在 background page 中实现双向管道时需要识别连接的 <code class="css-m301d5">tab.id</code>。</p><p class="css-zitybv">在这个通信过程中，我们再次遇到了和 Eval 接口一样的问题：只能传递 JSON 序列化的数据。序列化，或者说更广义的编码/解码，是很多通讯方式的基础，遥远如书信，信息被编码为文字，近如网络，信息被编码为数字信号。编码再解码后的得到的信息其实不是真正的原始信息，而是一份有损的拷贝，正如电话里听到的是手机扬声器还原的对方的声音，网络视频里看到的是屏幕上绘制的对方镜头的影像拷贝。</p><p class="css-zitybv">我们的扩展程序需要展示一些数据结构信息，其中难免包含复杂对象类型或循环引用的数据，那如何解决 JSON 序列化的问题呢？再次参考 React Developer Tools 的源码，它使用了一对命名为 <code class="css-m301d5">dehydrate</code> 和 <code class="css-m301d5">hydrate</code> （脱水和补水）的函数，发送消息前，<code class="css-m301d5">dehydrate</code> 将原始信息进行<em class="css-0">脱水</em>，将复杂对象类型转换为特定的可以被 JSON 序列化的结构信息，接收消息时，对数据进行<em class="css-0">补水</em>，还原得到原始的对象类型。</p><p class="css-zitybv">这对函数的命名有点意思，让我想到了科幻小说《三体》里的情节，三体人为了在乱纪元中生存，会自我<em class="css-0">脱水</em>进入休眠状态，而到了恒纪元则完成<em class="css-0">补水</em>重新苏醒。这或许正如复杂数据想要在通信中保持相对完整也需要进行脱水和补水一样。</p><p class="css-zitybv">回到主题，一个简单的脱水效果大约如下：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token comment">// 脱水前</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> event </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">CustomEvent</span><span class="token punctuation">(</span><span class="token string">&quot;something-happened&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  detail</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;oops&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> input </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  firedEvent</span><span class="token punctuation">:</span><span class="token plain"> event</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 执行脱水</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> output </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">dehydrate</span><span class="token punctuation">(</span><span class="token plain">input</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 脱水后</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">output</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 普通对象如 `{ firedEvent: ... }` 保留原结构</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  firedEvent</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 复杂对象被转换为特定结构，并附带一些跟该类型相关的信息</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// `__dehydrated_use_only__` 是一个用于识别脱水数据的特殊 key</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    __dehydrated_use_only__</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      constructorName</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;CustomEvent&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      children</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;something-happened&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        detail</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;oops&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre><p class="css-zitybv">脱水后的数据不再包含循环引用，并且在补水后可以还原得到原始对象类型的相关信息，虽然是有损的，但已经能满足界面展示数据类型的需求。</p><p class="css-zitybv">但是，React Developer Tools 的实现中没有包含对循环引用的处理，它通过限制递归层级绕开了这个问题，只在用户需要访问更深层级的数据时再去实时获取。</p><p class="css-zitybv">我尝试采取了另一种方案，在返回的数据中额外包含一个映射表，存储所有被多次引用的对象，同时对 <code class="css-m301d5">dehydrate</code> 的数据扩展一种映射类型，表示数据存放在映射表中。优化后的脱水效果大约如下：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token comment">// 脱水前</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> person </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  name</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;Good Man&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">person</span><span class="token punctuation">.</span><span class="token property-access">loves</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> person</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 执行脱水</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> dehydratedPerson </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">dehydrate</span><span class="token punctuation">(</span><span class="token plain">person</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 脱水后</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// `value` 固定为 `dehydrate()` 结果的主体数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">dehydratedPerson</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  name</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;Good Man&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  loves</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    __dehydrated_use_only__</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;ref&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      ref</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// `repo` 固定为 `dehydrate()` 结果的引用映射表</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">dehydratedPerson</span><span class="token punctuation">.</span><span class="token property-access">repo</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    name</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;Good Man&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    loves</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      __dehydrated_use_only__</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;ref&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        ref</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre><p class="css-zitybv">补水后则可以还原循环引用关系：</p><pre class="language-js prism-code language-javascript css-194ank4"><div class="token-line"><span class="token comment">// 补水</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> person </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">hydrate</span><span class="token punctuation">(</span><span class="token plain">dehydratedPerson</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">person</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">&quot;Good Man&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">person</span><span class="token punctuation">.</span><span class="token property-access">loves</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token plain">person</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre><p class="css-zitybv">至此，当下的主要困难都已经被解决。Keep exploring.</p><blockquote class="css-1vwrubw"><p class="css-zitybv">注：本文代码均只作示意用途，非实际代码。该扩展程序已发布：<a href="https://chrome.google.com/webstore/detail/brick-next-developer-tool/imfbjbfcldgkdbfgeoppalofbjfihpdp" class="css-19seewt">Brick Next Developer Tools</a>，源码托管在 GitHub：<a href="https://github.com/easyops-cn/brick-next-devtools" class="css-19seewt">brick-next-devtools</a>。</p></blockquote></section></article></main><style data-emotion-css="1i8tjli">.css-1i8tjli{margin-top:32px;padding-top:16px;}</style><footer class="css-1i8tjli"><hr class="css-kbbagd"/><style data-emotion-css="j6r63x">.css-j6r63x{margin-bottom:32px;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><style data-emotion-css="u5xevn">.css-u5xevn{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-bottom:32px;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-u5xevn"><style data-emotion-css="1emx3y6">.css-1emx3y6{margin-right:8px;margin-bottom:0;width:48px;min-width:48px;border-radius:99999px;}</style><div class="css-1emx3y6 gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:48px;height:48px"><img aria-hidden="true" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAC4jAAAuIwF4pT92AAAEj0lEQVQ4y02UWWxUVRjH777MTKdTKIEioASDZYsQVmMhIkQwJVaIsUrYiqVUoJ0ynXam0+ls3TvdKVtZLIhGYqMxKEYfIMYnQmJ8NtFHH4wPPvpifn73DqAPv5x779z7+/7nO+eM0pLsoUTmGeeekujhjPBhp0ea5o40TfFuGmNdnDyf5GQsScP5BCfaOjkW7eBISztKvCeLR/sTYv/jfLpEtDtLa0qKdfXQKtfxwoDPuVRWCiQ5JTS2J6RIJ0o6nyWdz9H9jDwpoSuXIykkhM6sSDJZOvMFKZRhX90hXttfy6m2GO25vMwi6dPcIcK+gRy9QkHI9+fIPaUvR1bI9OZI93qFsvSNDvNKzU4URfFxg2GONzeTLORoTSZ8lNFiD6PFDMWRLMVijuJogeGRPIPDOQaGcvQPecUyjEwMcvrsaRFpaLqBYdq+dPmK50kV0nRmksTTkvDKRJLLwuyFbsaH4/Tno0yNdTE1nmZiNI1XsCgFJyZ7Wb+u2pfoItQ0HVXVcF2X9mSUTH+KZLYD5c50jI+Fu7NdFBLH6e06wbWpdq7PJLg8GWdmIs6VmRR9+XNEQkFsVRWZhmEYvnz1S6sojqUp9MXJFWSVv5hu5rvrbeRbD1IRibB98zpmh5r4/KoUmolyc6qFuYttXBo7y4rFFZgiMQzdl0UiIdKpBiYnYgwOnPNRHlw4yk9zTfSe2u2/ZMhUNqyqInb8de5fO8Pd6UY+mfyAr2628n7dDjR5x9Fl2qpCIlrH7astTA2LdOQk40MNKD9Pv80v1+qZT+8jaKmEHdMXr3+hkgeXj3L/wmHmx9/j4UeN9LbsRZXfLN1m2ZJKbo0fYW7sMLPD9VwZqufi4Lsof17aw+8ze/nr5gEOv7rCl1maimNofJl7g0cXD/GjFL0/WsebNdVoVgQ3vBjFXEB97Wa+mXmHWwMHmOuv5UZfLco/t7fw9+w2uL2LfN1KSaAy37KR1Yscdq2p5I8btTwa2cvalVVSLCh7rwIrsAA7sBDDXUTy2FbuDe3hTmaXj8IP1XBvLXy7iV9H1/s9/G14K/NNpS0yc2QNBzY/L9cBfyMbThhLcAMRSRlh65plfN2zjc86NvFpfBPKW9tCHNwS4m50KY/7X8QxdRL7l8DcDjZUBVG0MlSrJNKccjRbrgXbDcvzcmqqq3jctZGHsXV837bWC+FtARVvXLnQpczSWBY2aNi+kKVhG92TyRQ1JyL9C6GZIVQRWiLUpcDLyytJ7X6O2M4qojVLUMpck/KgTURwbZuQJAyopbPqeOdVFsgTqUYAVQ+gyKKodrmf2O+nI89UCaUZJYKORci1KRPCQYeQpRMUYUj2misrHbBMdMMVoUilZ4otQkmmi9AOVBAMuPK9KVj+qARsA1ckAcsgaJsEJKGte9tG9++DtiV9K5dkC0RWURLKvddPy434vwf970sORZezaUgi0xt1DVNSeaOhl+69Y+b1T7FFaP0n9PpnitCUM23KOx6WdyQN769Il1Ry4E3de2jgWDa29NMxTUlvyxRF6FSUhE+kXhEvofe+J7JN+U74F/sJzXkeSJ6CAAAAAElFTkSuQmCC" alt="Shenwei Wang" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/2b467d8e9e1c0d3a8662ef8c8a223a18/aff39/avatar.png 1x,
/static/2b467d8e9e1c0d3a8662ef8c8a223a18/e5b88/avatar.png 1.5x,
/static/2b467d8e9e1c0d3a8662ef8c8a223a18/88b72/avatar.png 2x" /><img loading="lazy" width="48" height="48" srcset="/static/2b467d8e9e1c0d3a8662ef8c8a223a18/aff39/avatar.png 1x,
/static/2b467d8e9e1c0d3a8662ef8c8a223a18/e5b88/avatar.png 1.5x,
/static/2b467d8e9e1c0d3a8662ef8c8a223a18/88b72/avatar.png 2x" src="/static/2b467d8e9e1c0d3a8662ef8c8a223a18/aff39/avatar.png" alt="Shenwei Wang" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><div class="css-0">Personal Blog by <a class="css-19seewt" href="/">Shenwei Wang</a>.<br/>Writing code, raising kid, exploring the world.</div></div><style data-emotion-css="11r1i3o">.css-11r1i3o{-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;list-style:none;padding:0;}</style><style data-emotion-css="15qbtrw">.css-15qbtrw{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;list-style:none;padding:0;}</style><ul class="css-15qbtrw"><li><a rel="prev" class="css-19seewt" href="/my-first-vscode-extension/">← <!-- -->我的第一个 VS Code 扩展</a></li><li><a rel="next" class="css-19seewt" href="/multilingual-full-text-search/">多语言全文搜索<!-- --> →</a></li></ul></footer></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='UA-158375679-1',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
  if(!(parseInt(navigator.doNotTrack) === 1 || parseInt(window.doNotTrack) === 1 || parseInt(navigator.msDoNotTrack) === 1 || navigator.doNotTrack === "yes")) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-158375679-1', 'auto', {"siteSpeedSampleRate":33});
      ga('set', 'anonymizeIp', true);
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/writing-a-chrome-devtools-extension/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-c92f2bc1a503c2693b02.js"],"app":["/app-bc0fa8565171cdc976ba.js"],"component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js":["/component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js-e132334849c54914e889.js"],"component---node-modules-gatsby-theme-blog-core-src-templates-posts-query-js":["/component---node-modules-gatsby-theme-blog-core-src-templates-posts-query-js-deca618258bfbf2a083d.js"],"component---src-pages-404-js":["/component---src-pages-404-js-923f2d364aee2c4033db.js"]};/*]]>*/</script><script src="/polyfill-c92f2bc1a503c2693b02.js" nomodule=""></script><script src="/component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js-e132334849c54914e889.js" async=""></script><script src="/commons-c09e6334871a95b3802a.js" async=""></script><script src="/app-bc0fa8565171cdc976ba.js" async=""></script><script src="/styles-2d4804b503525347efbe.js" async=""></script><script src="/framework-42897c4e770e3c8b7b7b.js" async=""></script><script src="/webpack-runtime-4d61d6f36b696a0865b2.js" async=""></script></body></html>